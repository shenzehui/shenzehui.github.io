<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta property="og:url" content="https://newzone.top/netty/chapter10.html"><meta property="og:site_name" content="Javaè¾¾æ‘©é™¢"><meta property="og:title" content="ç¬¬åç«  Netty æ ¸å¿ƒæºç å‰–æ"><meta property="og:description" content="10.1 åŸºæœ¬è¯´æ˜"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-05-26T11:06:46.000Z"><meta property="article:author" content="Marico"><meta property="article:tag" content="Netty"><meta property="article:modified_time" content="2023-05-26T11:06:46.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"ç¬¬åç«  Netty æ ¸å¿ƒæºç å‰–æ","image":[""],"dateModified":"2023-05-26T11:06:46.000Z","author":[{"@type":"Person","name":"Marico","url":"https://github.com/shenzehui"}]}</script><link rel="icon" href="https://javablog-image.oss-cn-hangzhou.aliyuncs.com/blog/favicon.ico"><link rel="icon" href="/assets/512.png" type="image/png" sizes="512x512"><link rel="icon" href="/assets/192.png" type="image/png" sizes="192x192"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#096dd9"><link rel="apple-touch-icon" href="/assets/152.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileImage" content="/assets/144.png"><meta name="msapplication-TileColor" content="#ffffff"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"><title>ç¬¬åç«  Netty æ ¸å¿ƒæºç å‰–æ | Javaè¾¾æ‘©é™¢</title><meta name="description" content="10.1 åŸºæœ¬è¯´æ˜">
    <meta name="keywords" content="è‡ªæˆ‘æå‡,æ•ˆç‡æå‡,å¼€æºå·¥å…·,å­¦ä¹ ç¬”è®°" />
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-fd00c24c.css" as="style"><link rel="stylesheet" href="/assets/style-fd00c24c.css">
    <link rel="modulepreload" href="/assets/app-7a87900e.js"><link rel="modulepreload" href="/assets/chapter10.html-52a2fc52.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="modulepreload" href="/assets/chapter10.html-22afd77d.js">
    <!-- çœ‹æ¿å¨˜åŒºå— -->
    <link href="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-y/font-awesome/6.0.0/css/all.min.css" type="text/css" rel="stylesheet" />
    <script src="/live2d-widget/autoload.js"></script>
    <!-- End çœ‹æ¿å¨˜åŒºå— -->
    <!-- Matomo æ­¤åŒºå—ä¸ºç»Ÿè®¡ä»£ç ï¼Œè¯·åˆ é™¤-->
    <script>
      var _paq = window._paq = window._paq || [];
      /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="https://piwik.seoipo.com/";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '7']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    <!-- End Matomo Code æ­¤åŒºå—ä¸ºç»Ÿè®¡ä»£ç ï¼Œè¯·åˆ é™¤-->
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button type="button" class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a href="/" class="brand"><img class="logo" src="/logo.svg" alt="Javaè¾¾æ‘©é™¢"><!----><span class="site-name hide-in-pad">Javaè¾¾æ‘©é™¢</span></a><!--]--><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><!--[--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/blog.html" class="nav-link" aria-label="åšå®¢ä¸»é¡µ"><span class="font-icon icon iconfont icon-home" style=""></span>åšå®¢ä¸»é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><a href="/mianshi/" class="nav-link" aria-label="é¢è¯•"><span class="font-icon icon iconfont icon-like" style=""></span>é¢è¯•<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="æ•°æ®åº“"><span class="title"><span class="font-icon icon iconfont icon-mysql" style=""></span>æ•°æ®åº“</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/database/mysql/" class="nav-link" aria-label="MySQL"><!---->MySQL<!----></a></li><li class="dropdown-item"><a href="/database/redis/" class="nav-link" aria-label="Redis"><!---->Redis<!----></a></li><li class="dropdown-item"><a href="/database/mongodb/" class="nav-link" aria-label="MongoDB"><!---->MongoDB<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="/algorithm/" class="nav-link" aria-label="æ•°æ®ç»“æ„ç®—æ³•"><span class="font-icon icon iconfont icon-creative" style=""></span>æ•°æ®ç»“æ„ç®—æ³•<!----></a></div><div class="nav-item hide-in-mobile"><a href="/spring/" class="nav-link" aria-label="Spring"><span class="font-icon icon iconfont icon-leaf" style=""></span>Spring<!----></a></div><div class="nav-item hide-in-mobile"><a href="/springcloud/" class="nav-link" aria-label="SpringCloud"><span class="font-icon icon iconfont icon-cache" style=""></span>SpringCloud<!----></a></div><div class="nav-item hide-in-mobile"><a href="/netty/" class="nav-link active" aria-label="Netty 4.x"><span class="font-icon icon iconfont icon-cache" style=""></span>Netty 4.x<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="è®¡ç®—æœºåŸºç¡€"><span class="title"><span class="font-icon icon iconfont icon-computer" style=""></span>è®¡ç®—æœºåŸºç¡€</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/cs/os/" class="nav-link" aria-label="è®¡ç®—æœºæ“ä½œç³»ç»Ÿ"><!---->è®¡ç®—æœºæ“ä½œç³»ç»Ÿ<!----></a></li><li class="dropdown-item"><a href="/cs/internet/" class="nav-link" aria-label="è®¡ç®—æœºç½‘ç»œ"><!---->è®¡ç®—æœºç½‘ç»œ<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="å·¥å…·|éƒ¨ç½²"><span class="title"><span class="font-icon icon iconfont icon-operate" style=""></span>å·¥å…·|éƒ¨ç½²</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/tools/git.html" class="nav-link" aria-label="Gitè¯¦è§£"><!---->Gitè¯¦è§£<!----></a></li><li class="dropdown-item"><a href="/tools/maven.html" class="nav-link" aria-label="Mavenä»‹ç»"><!---->Mavenä»‹ç»<!----></a></li><li class="dropdown-item"><a href="/tools/linux.md" class="nav-link" aria-label="Linux"><!---->Linux<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="/projectlearn/" class="nav-link" aria-label="å¼€æºé¡¹ç›®å­¦ä¹ "><span class="font-icon icon iconfont icon-repo" style=""></span>å¼€æºé¡¹ç›®å­¦ä¹ <!----></a></div><div class="nav-item hide-in-mobile"><a href="/nicearticle/art01.html" class="nav-link" aria-label="å¥½æ–‡æ”¶é›†"><span class="font-icon icon iconfont icon-repo" style=""></span>å¥½æ–‡æ”¶é›†<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!--[--><div class="nav-item"><a class="repo-link" href="https://github.com/shenzehui/shenzehui.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" class="outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form><!--]--><!--[--><!----><!--]--><button type="button" class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a href="/netty/" class="nav-link sidebar-link sidebar-page" aria-label="ğŸ‘‰èµ·æ­¥"><!---->ğŸ‘‰èµ·æ­¥<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/netty/chapter01.html" class="nav-link sidebar-link sidebar-page" aria-label="ç¬¬ä¸€ç«  Netty ä»‹ç»å’Œåº”ç”¨åœºæ™¯"><!---->ç¬¬ä¸€ç«  Netty ä»‹ç»å’Œåº”ç”¨åœºæ™¯<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/netty/chapter02.html" class="nav-link sidebar-link sidebar-page" aria-label="ç¬¬äºŒç«  Java BIO ç¼–ç¨‹"><!---->ç¬¬äºŒç«  Java BIO ç¼–ç¨‹<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/netty/chapter03.html" class="nav-link sidebar-link sidebar-page" aria-label="ç¬¬ä¸‰ç«  Java NIO ç¼–ç¨‹"><!---->ç¬¬ä¸‰ç«  Java NIO ç¼–ç¨‹<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/netty/chapter04.html" class="nav-link sidebar-link sidebar-page" aria-label="ç¬¬å››ç«  Netty æ¦‚è¿°"><!---->ç¬¬å››ç«  Netty æ¦‚è¿°<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/netty/chapter05.html" class="nav-link sidebar-link sidebar-page" aria-label="ç¬¬äº”ç«  Netty é«˜æ€§èƒ½æ¶æ„è®¾è®¡"><!---->ç¬¬äº”ç«  Netty é«˜æ€§èƒ½æ¶æ„è®¾è®¡<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/netty/chapter06.html" class="nav-link sidebar-link sidebar-page" aria-label="ç¬¬å…­ç«  Netty æ ¸å¿ƒæ¨¡å—ç»„ä»¶"><!---->ç¬¬å…­ç«  Netty æ ¸å¿ƒæ¨¡å—ç»„ä»¶<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/netty/chapter07.html" class="nav-link sidebar-link sidebar-page" aria-label="ç¬¬ä¸ƒç«  Google Protobuf"><!---->ç¬¬ä¸ƒç«  Google Protobuf<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/netty/chapter08.html" class="nav-link sidebar-link sidebar-page" aria-label="ç¬¬å…«ç«  Netty ç¼–è§£ç å™¨å’Œ Handler è°ƒç”¨æœºåˆ¶"><!---->ç¬¬å…«ç«  Netty ç¼–è§£ç å™¨å’Œ Handler è°ƒç”¨æœºåˆ¶<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/netty/chapter09.html" class="nav-link sidebar-link sidebar-page" aria-label="ç¬¬ä¹ç«  TCP ç²˜åŒ…å’Œæ‹†åŒ…åŠè§£å†³æ–¹æ¡ˆ"><!---->ç¬¬ä¹ç«  TCP ç²˜åŒ…å’Œæ‹†åŒ…åŠè§£å†³æ–¹æ¡ˆ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/netty/chapter10.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="ç¬¬åç«  Netty æ ¸å¿ƒæºç å‰–æ"><!---->ç¬¬åç«  Netty æ ¸å¿ƒæºç å‰–æ<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-1-åŸºæœ¬è¯´æ˜" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.1 åŸºæœ¬è¯´æ˜"><!---->10.1 åŸºæœ¬è¯´æ˜<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-2-netty-å¯åŠ¨è¿‡ç¨‹æºç å‰–æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.2 Netty å¯åŠ¨è¿‡ç¨‹æºç å‰–æ"><!---->10.2 Netty å¯åŠ¨è¿‡ç¨‹æºç å‰–æ<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-2-1-æºç å‰–æç›®çš„" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.2.1 æºç å‰–æç›®çš„"><!---->10.2.1 æºç å‰–æç›®çš„<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-2-2-æºç å‰–æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.2.2 æºç å‰–æ"><!---->10.2.2 æºç å‰–æ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-2-3-æºç å‰–æè¿‡ç¨‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.2.3 æºç å‰–æè¿‡ç¨‹"><!---->10.2.3 æºç å‰–æè¿‡ç¨‹<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-2-4-netty-å¯åŠ¨è¿‡ç¨‹æ¢³ç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.2.4 Netty å¯åŠ¨è¿‡ç¨‹æ¢³ç†"><!---->10.2.4 Netty å¯åŠ¨è¿‡ç¨‹æ¢³ç†<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-3-netty-æ¥å—è¯·æ±‚è¿‡ç¨‹æºç å‰–æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.3 Netty æ¥å—è¯·æ±‚è¿‡ç¨‹æºç å‰–æ"><!---->10.3 Netty æ¥å—è¯·æ±‚è¿‡ç¨‹æºç å‰–æ<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-3-1-æºç å‰–æç›®çš„" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.3.1 æºç å‰–æç›®çš„"><!---->10.3.1 æºç å‰–æç›®çš„<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-3-2-æºç å‰–æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.3.2 æºç å‰–æ"><!---->10.3.2 æºç å‰–æ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-3-3-netty-æ¥å—è¯·æ±‚è¿‡ç¨‹æ¢³ç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.3.3 Netty æ¥å—è¯·æ±‚è¿‡ç¨‹æ¢³ç†"><!---->10.3.3 Netty æ¥å—è¯·æ±‚è¿‡ç¨‹æ¢³ç†<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-4-pipeline-handler-handlercontext-åˆ›å»ºæºç å‰–æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.4 Pipeline Handler HandlerContext åˆ›å»ºæºç å‰–æ"><!---->10.4 Pipeline Handler HandlerContext åˆ›å»ºæºç å‰–æ<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-4-1-æºç å‰–æç›®çš„" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.4.1 æºç å‰–æç›®çš„"><!---->10.4.1 æºç å‰–æç›®çš„<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-4-2-æºç å‰–æè¯´æ˜" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.4.2 æºç å‰–æè¯´æ˜"><!---->10.4.2 æºç å‰–æè¯´æ˜<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-4-3-æºç å‰–æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.4.3 æºç å‰–æ"><!---->10.4.3 æºç å‰–æ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-4-4-pipeline-handler-handlercontext-åˆ›å»ºè¿‡ç¨‹æ¢³ç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.4.4 Pipeline Handler HandlerContext åˆ›å»ºè¿‡ç¨‹æ¢³ç†"><!---->10.4.4 Pipeline Handler HandlerContext åˆ›å»ºè¿‡ç¨‹æ¢³ç†<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-5-channelpipeline-è°ƒåº¦-handler-çš„æºç å‰–æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.5 ChannelPipeline è°ƒåº¦ handler çš„æºç å‰–æ"><!---->10.5 ChannelPipeline è°ƒåº¦ handler çš„æºç å‰–æ<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-5-1-æºç å‰–æç›®çš„" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.5.1 æºç å‰–æç›®çš„"><!---->10.5.1 æºç å‰–æç›®çš„<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-5-2-æºç å‰–æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.5.2 æºç å‰–æ"><!---->10.5.2 æºç å‰–æ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-5-3-channelpipeline-è°ƒåº¦-handler-æ¢³ç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.5.3 ChannelPipeline è°ƒåº¦ handler æ¢³ç†"><!---->10.5.3 ChannelPipeline è°ƒåº¦ handler æ¢³ç†<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-6-netty-å¿ƒè·³-heartbeat-æœåŠ¡æºç å‰–æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.6 Netty å¿ƒè·³(heartbeat)æœåŠ¡æºç å‰–æ"><!---->10.6 Netty å¿ƒè·³(heartbeat)æœåŠ¡æºç å‰–æ<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-6-1-æºç å‰–æç›®çš„" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.6.1 æºç å‰–æç›®çš„"><!---->10.6.1 æºç å‰–æç›®çš„<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-6-2-æºç å‰–æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.6.2 æºç å‰–æ"><!---->10.6.2 æºç å‰–æ<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-7-netty-æ ¸å¿ƒç»„ä»¶-eventloop-æºç å‰–æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.7 Netty æ ¸å¿ƒç»„ä»¶ EventLoop æºç å‰–æ"><!---->10.7 Netty æ ¸å¿ƒç»„ä»¶ EventLoop æºç å‰–æ<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-7-1-æºç å‰–æç›®çš„" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.7.1 æºç å‰–æç›®çš„"><!---->10.7.1 æºç å‰–æç›®çš„<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-7-2-æºç å‰–æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.7.2 æºç å‰–æ"><!---->10.7.2 æºç å‰–æ<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-8-handler-ä¸­åŠ å…¥çº¿ç¨‹æ± å’Œ-context-ä¸­æ·»åŠ çº¿ç¨‹æ± çš„æºç å‰–æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.8 handler ä¸­åŠ å…¥çº¿ç¨‹æ± å’Œ Context ä¸­æ·»åŠ çº¿ç¨‹æ± çš„æºç å‰–æ"><!---->10.8 handler ä¸­åŠ å…¥çº¿ç¨‹æ± å’Œ Context ä¸­æ·»åŠ çº¿ç¨‹æ± çš„æºç å‰–æ<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-8-1-æºç å‰–æç›®çš„" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.8.1 æºç å‰–æç›®çš„"><!---->10.8.1 æºç å‰–æç›®çš„<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/netty/chapter10.html#_10-8-2-æºç å‰–æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="10.8.2 æºç å‰–æ"><!---->10.8.2 æºç å‰–æ<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/netty/chapter11.html" class="nav-link sidebar-link sidebar-page" aria-label="ç¬¬åä¸€ç«  ç”¨ Netty è‡ªå·±å®ç° Dubbo RPC"><!---->ç¬¬åä¸€ç«  ç”¨ Netty è‡ªå·±å®ç° Dubbo RPC<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->ç¬¬åç«  Netty æ ¸å¿ƒæºç å‰–æ</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://github.com/shenzehui" target="_blank" rel="noopener noreferrer">Marico</a></span><span property="author" content="Marico"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-05-26T11:06:46.000Z"></span><span class="page-category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item category5 clickable" role="navigation">Netty</span><!--]--><meta property="articleSection" content="Netty"></span><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag5 clickable" role="navigation">Netty</span><!--]--><meta property="keywords" content="Netty"></span><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 45 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT45M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-1-åŸºæœ¬è¯´æ˜" class="router-link-active router-link-exact-active toc-link level2">10.1 åŸºæœ¬è¯´æ˜</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-2-netty-å¯åŠ¨è¿‡ç¨‹æºç å‰–æ" class="router-link-active router-link-exact-active toc-link level2">10.2 Netty å¯åŠ¨è¿‡ç¨‹æºç å‰–æ</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-2-1-æºç å‰–æç›®çš„" class="router-link-active router-link-exact-active toc-link level3">10.2.1 æºç å‰–æç›®çš„</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-2-2-æºç å‰–æ" class="router-link-active router-link-exact-active toc-link level3">10.2.2 æºç å‰–æ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-2-3-æºç å‰–æè¿‡ç¨‹" class="router-link-active router-link-exact-active toc-link level3">10.2.3 æºç å‰–æè¿‡ç¨‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-2-4-netty-å¯åŠ¨è¿‡ç¨‹æ¢³ç†" class="router-link-active router-link-exact-active toc-link level3">10.2.4 Netty å¯åŠ¨è¿‡ç¨‹æ¢³ç†</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-3-netty-æ¥å—è¯·æ±‚è¿‡ç¨‹æºç å‰–æ" class="router-link-active router-link-exact-active toc-link level2">10.3 Netty æ¥å—è¯·æ±‚è¿‡ç¨‹æºç å‰–æ</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-3-1-æºç å‰–æç›®çš„" class="router-link-active router-link-exact-active toc-link level3">10.3.1 æºç å‰–æç›®çš„</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-3-2-æºç å‰–æ" class="router-link-active router-link-exact-active toc-link level3">10.3.2 æºç å‰–æ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-3-3-netty-æ¥å—è¯·æ±‚è¿‡ç¨‹æ¢³ç†" class="router-link-active router-link-exact-active toc-link level3">10.3.3 Netty æ¥å—è¯·æ±‚è¿‡ç¨‹æ¢³ç†</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-4-pipeline-handler-handlercontext-åˆ›å»ºæºç å‰–æ" class="router-link-active router-link-exact-active toc-link level2">10.4 Pipeline Handler HandlerContext åˆ›å»ºæºç å‰–æ</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-4-1-æºç å‰–æç›®çš„" class="router-link-active router-link-exact-active toc-link level3">10.4.1 æºç å‰–æç›®çš„</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-4-2-æºç å‰–æè¯´æ˜" class="router-link-active router-link-exact-active toc-link level3">10.4.2 æºç å‰–æè¯´æ˜</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-4-3-æºç å‰–æ" class="router-link-active router-link-exact-active toc-link level3">10.4.3 æºç å‰–æ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-4-4-pipeline-handler-handlercontext-åˆ›å»ºè¿‡ç¨‹æ¢³ç†" class="router-link-active router-link-exact-active toc-link level3">10.4.4 Pipeline Handler HandlerContext åˆ›å»ºè¿‡ç¨‹æ¢³ç†</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-5-channelpipeline-è°ƒåº¦-handler-çš„æºç å‰–æ" class="router-link-active router-link-exact-active toc-link level2">10.5 ChannelPipeline è°ƒåº¦ handler çš„æºç å‰–æ</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-5-1-æºç å‰–æç›®çš„" class="router-link-active router-link-exact-active toc-link level3">10.5.1 æºç å‰–æç›®çš„</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-5-2-æºç å‰–æ" class="router-link-active router-link-exact-active toc-link level3">10.5.2 æºç å‰–æ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-5-3-channelpipeline-è°ƒåº¦-handler-æ¢³ç†" class="router-link-active router-link-exact-active toc-link level3">10.5.3 ChannelPipeline è°ƒåº¦ handler æ¢³ç†</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-6-netty-å¿ƒè·³-heartbeat-æœåŠ¡æºç å‰–æ" class="router-link-active router-link-exact-active toc-link level2">10.6 Netty å¿ƒè·³(heartbeat)æœåŠ¡æºç å‰–æ</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-6-1-æºç å‰–æç›®çš„" class="router-link-active router-link-exact-active toc-link level3">10.6.1 æºç å‰–æç›®çš„</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-6-2-æºç å‰–æ" class="router-link-active router-link-exact-active toc-link level3">10.6.2 æºç å‰–æ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-7-netty-æ ¸å¿ƒç»„ä»¶-eventloop-æºç å‰–æ" class="router-link-active router-link-exact-active toc-link level2">10.7 Netty æ ¸å¿ƒç»„ä»¶ EventLoop æºç å‰–æ</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-7-1-æºç å‰–æç›®çš„" class="router-link-active router-link-exact-active toc-link level3">10.7.1 æºç å‰–æç›®çš„</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-7-2-æºç å‰–æ" class="router-link-active router-link-exact-active toc-link level3">10.7.2 æºç å‰–æ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-8-handler-ä¸­åŠ å…¥çº¿ç¨‹æ± å’Œ-context-ä¸­æ·»åŠ çº¿ç¨‹æ± çš„æºç å‰–æ" class="router-link-active router-link-exact-active toc-link level2">10.8 handler ä¸­åŠ å…¥çº¿ç¨‹æ± å’Œ Context ä¸­æ·»åŠ çº¿ç¨‹æ± çš„æºç å‰–æ</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-8-1-æºç å‰–æç›®çš„" class="router-link-active router-link-exact-active toc-link level3">10.8.1 æºç å‰–æç›®çš„</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/netty/chapter10.html#_10-8-2-æºç å‰–æ" class="router-link-active router-link-exact-active toc-link level3">10.8.2 æºç å‰–æ</a></li><!----><!--]--></ul></li><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h2 id="_10-1-åŸºæœ¬è¯´æ˜" tabindex="-1"><a class="header-anchor" href="#_10-1-åŸºæœ¬è¯´æ˜" aria-hidden="true">#</a> 10.1 åŸºæœ¬è¯´æ˜</h2><ol><li>åªæœ‰çœ‹è¿‡ <code>Netty</code> æºç ï¼Œæ‰èƒ½è¯´æ˜¯çœŸçš„æŒæ¡äº† <code>Netty</code> æ¡†æ¶ã€‚</li><li>åœ¨ <code>io.netty.example</code> åŒ…ä¸‹ï¼Œæœ‰å¾ˆå¤š <code>Netty</code> æºç æ¡ˆä¾‹ï¼Œå¯ä»¥ç”¨æ¥åˆ†æã€‚</li><li>æºç åˆ†æç« èŠ‚æ˜¯é’ˆå¯¹æœ‰ <code>Java</code> é¡¹ç›®ç»éªŒï¼Œå¹¶ä¸”ç©è¿‡æ¡†æ¶æºç çš„äººå‘˜è®²çš„ï¼Œå¦åˆ™ä½ å¬èµ·æ¥ä¼šæœ‰ç›¸å½“çš„éš¾åº¦ã€‚</li></ol><h2 id="_10-2-netty-å¯åŠ¨è¿‡ç¨‹æºç å‰–æ" tabindex="-1"><a class="header-anchor" href="#_10-2-netty-å¯åŠ¨è¿‡ç¨‹æºç å‰–æ" aria-hidden="true">#</a> 10.2 Netty å¯åŠ¨è¿‡ç¨‹æºç å‰–æ</h2><h3 id="_10-2-1-æºç å‰–æç›®çš„" tabindex="-1"><a class="header-anchor" href="#_10-2-1-æºç å‰–æç›®çš„" aria-hidden="true">#</a> 10.2.1 æºç å‰–æç›®çš„</h3><p>ç”¨æºç åˆ†æçš„æ–¹å¼èµ°ä¸€ä¸‹ <code>Netty</code>ï¼ˆæœåŠ¡å™¨ï¼‰çš„å¯åŠ¨è¿‡ç¨‹ï¼Œæ›´å¥½çš„ç†è§£ <code>Netty</code> çš„æ•´ä½“è®¾è®¡å’Œè¿è¡Œæœºåˆ¶ã€‚</p><h3 id="_10-2-2-æºç å‰–æ" tabindex="-1"><a class="header-anchor" href="#_10-2-2-æºç å‰–æ" aria-hidden="true">#</a> 10.2.2 æºç å‰–æ</h3><p>è¯´æ˜ï¼š</p><ol><li>æºç éœ€è¦å‰–æåˆ° <code>Netty</code> è°ƒç”¨ <code>doBind</code> æ–¹æ³•ï¼Œè¿½è¸ªåˆ° <code>NioServerSocketChannel</code> çš„ <code>doBind</code>ã€‚</li><li>å¹¶ä¸”è¦ <code>Debug</code> ç¨‹åºåˆ° <code>NioEventLoop</code> ç±»çš„ <code>run</code> ä»£ç ï¼Œæ— é™å¾ªç¯ï¼Œåœ¨æœåŠ¡å™¨ç«¯è¿è¡Œã€‚</li></ol><p><img src="https://javablog-image.oss-cn-hangzhou.aliyuncs.com/blog/chapter10_01.png" alt="" loading="lazy"></p><h3 id="_10-2-3-æºç å‰–æè¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#_10-2-3-æºç å‰–æè¿‡ç¨‹" aria-hidden="true">#</a> 10.2.3 æºç å‰–æè¿‡ç¨‹</h3><p><strong>1. <code>demo</code> æºç çš„åŸºæœ¬ç†è§£</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token comment">// æœåŠ¡å™¨å¯åŠ¨ç±»æºç </span>
<span class="token comment">/*
 * Copyright 2012 The Netty Project
 *
 * The Netty Project licenses this file to you under the Apache License,
 * version 2.0 (the &quot;License&quot;); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at:
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations
 * under the License.
 */</span>
<span class="token keyword">package</span> <span class="token namespace">atguigu<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>example<span class="token punctuation">.</span>echo2</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>bootstrap<span class="token punctuation">.</span></span><span class="token class-name">ServerBootstrap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">ChannelFuture</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">ChannelInitializer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">ChannelOption</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">ChannelPipeline</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">EventLoopGroup</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span><span class="token class-name">NioEventLoopGroup</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>socket<span class="token punctuation">.</span></span><span class="token class-name">SocketChannel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span><span class="token class-name">NioServerSocketChannel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>logging<span class="token punctuation">.</span></span><span class="token class-name">LogLevel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>logging<span class="token punctuation">.</span></span><span class="token class-name">LoggingHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">SslContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">SslContextBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">SelfSignedCertificate</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * Echoes back any received data from a client.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">EchoServer</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token constant">SSL</span> <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;ssl&quot;</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">PORT</span> <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;8007&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// Configure SSL.</span>
        <span class="token keyword">final</span> <span class="token class-name">SslContext</span> sslCtx<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">SSL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">SelfSignedCertificate</span> ssc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SelfSignedCertificate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sslCtx <span class="token operator">=</span> <span class="token class-name">SslContextBuilder</span><span class="token punctuation">.</span><span class="token function">forServer</span><span class="token punctuation">(</span>ssc<span class="token punctuation">.</span><span class="token function">certificate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ssc<span class="token punctuation">.</span><span class="token function">privateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            sslCtx <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Configure the server.</span>
        <span class="token class-name">EventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_BACKLOG</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                            <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>sslCtx <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>sslCtx<span class="token punctuation">.</span><span class="token function">newHandler</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment">//p.addLast(new LoggingHandler(LogLevel.INFO));</span>
                            p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EchoServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Start the server.</span>
            <span class="token class-name">ChannelFuture</span> f <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Wait until the server socket is closed.</span>
            f<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// Shut down all event loops to terminate all threads.</span>
            bossGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            workerGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š</p><ol><li>å…ˆçœ‹å¯åŠ¨ç±»ï¼š<code>main</code> æ–¹æ³•ä¸­ï¼Œé¦–å…ˆåˆ›å»ºäº†å…³äº SSL çš„é…ç½®ç±»ã€‚</li><li>é‡ç‚¹åˆ†æä¸‹åˆ›å»ºäº†ä¸¤ä¸ª <code>EventLoopGroup</code> å¯¹è±¡ï¼š</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">EventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">EventLoopGroup</span> workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>(1) è¿™ä¸¤ä¸ªå¯¹è±¡æ˜¯æ•´ä¸ª <code>Netty</code> çš„æ ¸å¿ƒå¯¹è±¡ï¼Œå¯ä»¥è¯´ï¼Œæ•´ä¸ª <code>Netty</code> çš„è¿ä½œéƒ½ä¾èµ–äºä»–ä»¬ã€‚<code>bossGroup</code> ç”¨äºæ¥å— <code>TCP</code> è¯·æ±‚ï¼Œä»–ä¼šå°†è¯·æ±‚äº¤ç»™ <code>workerGroup</code>ï¼Œ<code>workerGroup</code> ä¼šè·å–åˆ°çœŸæ­£çš„è¿æ¥ï¼Œç„¶åå’Œè¿æ¥è¿›è¡Œé€šä¿¡ï¼Œæ¯”å¦‚è¯»å†™è§£ç ç¼–ç ç­‰æ“ä½œã€‚</p><p>(2) <code>EventLoopGroup</code> æ˜¯äº‹ä»¶å¾ªç¯ç»„ï¼ˆçº¿ç¨‹ç»„ï¼‰å«æœ‰å¤šä¸ª <code>EventLoop</code>ï¼Œå¯ä»¥æ³¨å†Œ <code>channel</code>ï¼Œç”¨äºåœ¨äº‹ä»¶å¾ªç¯ä¸­å»è¿›è¡Œé€‰æ‹©ï¼ˆå’Œé€‰æ‹©å™¨ç›¸å…³ï¼‰ã€‚ã€debugçœ‹ã€‘</p><p>(3) <code>new NioEventLoopGroup(1);</code> è¿™ä¸ª <code>1</code> è¡¨ç¤º <code>bossGroup</code> äº‹ä»¶ç»„æœ‰ <code>1</code> ä¸ªçº¿ç¨‹ä½ å¯ä»¥æŒ‡å®šï¼Œå¦‚æœ <code>new NioEventLoopGroup()</code> ä¼šå«æœ‰é»˜è®¤ä¸ªçº¿ç¨‹ <code>cpuæ ¸æ•° * 2</code>ï¼Œå³å¯ä»¥å……åˆ†çš„åˆ©ç”¨å¤šæ ¸çš„ä¼˜åŠ¿ï¼Œã€å¯ä»¥dubugä¸€æŠŠã€‘</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token constant">DEFAULT_EVENT_LOOP_THREADS</span> <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">SystemPropertyUtil</span><span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">&quot;io.netty.eventLoopThreads&quot;</span><span class="token punctuation">,</span> <span class="token class-name">NettyRuntime</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä¼šåˆ›å»º <code>EventExecutor</code> æ•°ç»„ <code>children = new EventExecutor[nThreads];</code> // <code>debug</code> ä¸€ä¸‹æ¯ä¸ªå…ƒç´ çš„ç±»å‹å°±æ˜¯ <code>NIOEventLoop</code>ï¼Œ<code>NIOEventLoop</code> å®ç°äº† <code>EventLoop</code> æ¥å£å’Œ <code>Executor</code> æ¥å£ <code>try</code> å—ä¸­åˆ›å»ºäº†ä¸€ä¸ª <code>ServerBootstrap</code> å¯¹è±¡ï¼Œä»–æ˜¯ä¸€ä¸ªå¼•å¯¼ç±»ï¼Œç”¨äºå¯åŠ¨æœåŠ¡å™¨å’Œå¼•å¯¼æ•´ä¸ªç¨‹åºçš„åˆå§‹åŒ–ï¼ˆçœ‹ä¸‹æºç  <code>allowseasybootstrapof{@linkServerChannel}</code>ï¼‰ã€‚å®ƒå’Œ <code>ServerChannel</code> å…³è”ï¼Œè€Œ <code>ServerChannel</code> ç»§æ‰¿äº† <code>Channel</code>ï¼Œæœ‰ä¸€äº›æ–¹æ³• <code>remoteAddress</code> ç­‰[å¯ä»¥Debugä¸‹]éšåï¼Œå˜é‡ <code>b</code> è°ƒç”¨äº† <code>group</code> æ–¹æ³•å°†ä¸¤ä¸ª <code>group</code> æ”¾å…¥äº†è‡ªå·±çš„å­—æ®µä¸­ï¼Œç”¨äºåæœŸå¼•å¯¼ä½¿ç”¨ã€<code>debug</code> ä¸‹ <code>group</code> æ–¹æ³•</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 *Set the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">EventLoopGroup</span></span><span class="token punctuation">}</span> for the parent (acceptor) and the child (client) . These
 *<span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">EventLoopGroup</span></span><span class="token punctuation">}</span>&#39;s are used to handle all the events and IO for <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ServerChannel</span></span><span class="token punctuation">}</span> and 
 *<span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Channel</span></span><span class="token punctuation">}</span>&#39;s.
 */</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ã€‘ã€‚</p><p>(4) ç„¶åæ·»åŠ äº†ä¸€ä¸ª <code>channel</code>ï¼Œå…¶ä¸­å‚æ•°ä¸€ä¸ª <code>Class</code> å¯¹è±¡ï¼Œå¼•å¯¼ç±»å°†é€šè¿‡è¿™ä¸ª <code>Class</code> å¯¹è±¡åå°„åˆ›å»º <code>ChannelFactory</code>ã€‚ç„¶åæ·»åŠ äº†ä¸€äº› <code>TCP</code> çš„å‚æ•°ã€‚ã€è¯´æ˜ï¼š<code>Channel</code> çš„åˆ›å»ºåœ¨ <code>bind</code> æ–¹æ³•ï¼Œå¯ä»¥ <code>Debug</code> ä¸‹ <code>bind</code>ï¼Œä¼šæ‰¾åˆ° <code>channel = channelFactory.newChannel();</code> ã€‘</p><p>(5) å†æ·»åŠ äº†ä¸€ä¸ªæœåŠ¡å™¨ä¸“å±çš„æ—¥å¿—å¤„ç†å™¨ <code>handler</code> ã€‚</p><p>(6) å†æ·»åŠ ä¸€ä¸ª <code>SocketChannel</code>ï¼ˆä¸æ˜¯ <code>ServerSocketChannel</code>ï¼‰çš„ <code>handler</code>ã€‚</p><p>(7) ç„¶åç»‘å®šç«¯å£å¹¶é˜»å¡è‡³è¿æ¥æˆåŠŸã€‚</p><p>(8) æœ€å <code>main</code> çº¿ç¨‹é˜»å¡ç­‰å¾…å…³é—­ã€‚</p><p>(9) <code>finally</code> å—ä¸­çš„ä»£ç å°†åœ¨æœåŠ¡å™¨å…³é—­æ—¶ä¼˜é›…å…³é—­æ‰€æœ‰èµ„æºã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token comment">/*
 * Copyright 2012 The Netty Project
 *
 * The Netty Project licenses this file to you under the Apache License,
 * version 2.0 (the &quot;License&quot;); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at:
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations
 * under the License.
 */</span>
<span class="token keyword">package</span> <span class="token namespace">atguigu<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>example<span class="token punctuation">.</span>echo2</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">ChannelHandler</span><span class="token punctuation">.</span><span class="token class-name">Sharable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">ChannelHandlerContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">ChannelInboundHandlerAdapter</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * Handler implementation for the echo server.
 */</span>
<span class="token annotation punctuation">@Sharable</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelReadComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Close the connection when an exception is raised.</span>
        cause<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜:</p><ol><li>è¿™æ˜¯ä¸€ä¸ªæ™®é€šçš„å¤„ç†å™¨ç±»ï¼Œç”¨äºå¤„ç†å®¢æˆ·ç«¯å‘é€æ¥çš„æ¶ˆæ¯ï¼Œåœ¨æˆ‘ä»¬è¿™é‡Œï¼Œæˆ‘ä»¬ç®€å•çš„è§£æå‡ºå®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„å†…å®¹ï¼Œç„¶åæ‰“å°ï¼Œæœ€åå‘é€å­—ç¬¦ä¸²ç»™å®¢æˆ·ç«¯ã€‚</li><li>å¤§è‡´è®²è§£äº†æˆ‘ä»¬çš„ <code>demo</code> æºç çš„ä½œç”¨ã€‚åé¢çš„ <code>debug</code> çš„æ—¶å€™ä¼šè¯¦ç»†ã€‚</li></ol><p><strong>2. åˆ†æ EventLoopGroup çš„è¿‡ç¨‹</strong></p><p>2.1 æ„é€ å™¨æ–¹æ³•</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token class-name">NioEventLoopGroup</span> <span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">this</span><span class="token punctuation">(</span>nThreads<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Executor</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2.2 ä¸Šé¢çš„ <code>this(nThreads, (Executor) null);</code> è°ƒç”¨æ„é€ å™¨ï¼ˆé€šè¿‡ <code>alt + d</code> çœ‹å³å¯ï¼‰</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">NioEventLoopGroup</span> <span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>nThreads<span class="token punctuation">,</span> executor<span class="token punctuation">,</span> <span class="token class-name">SelectorProvider</span><span class="token punctuation">.</span><span class="token function">provider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2.3 ä¸Šé¢çš„ <code>this(nThreads, executor, SelectorProvider.provider());</code> è°ƒç”¨ä¸‹é¢æ„é€ å™¨</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">NioEventLoopGroup</span> <span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">SelectorProvider</span> selectorProvider<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>nThreads<span class="token punctuation">,</span> executor<span class="token punctuation">,</span> selectorProvider<span class="token punctuation">,</span><span class="token class-name">DefaultSelectStrategyFactory</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2.4 ä¸Šé¢çš„ <code>this()...</code> è°ƒç”¨æ„é€ å™¨ï¼ˆ<code>alt + d</code>ï¼‰</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">NioEventLoopGroup</span> <span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">SelectorProvider</span> selectorProvider<span class="token punctuation">,</span><span class="token keyword">final</span> <span class="token class-name">SelectStrategyFactory</span> selectStrategyFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>nThreads<span class="token punctuation">,</span> executor<span class="token punctuation">,</span> selectorProvider<span class="token punctuation">,</span> selectStrategyFactory<span class="token punctuation">,</span> <span class="token class-name">RejectedExecutionHandlers</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2.5 ä¸Šé¢çš„ <code>super()..</code> çš„æ–¹æ³•æ˜¯çˆ¶ç±»ï¼š<code>MultithreadEventLoopGroup</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">MultithreadEventLoopGroup</span> <span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>nThreads <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token constant">DEFAULT_EVENT_LOOP_THREADS</span> <span class="token operator">:</span> nThreads<span class="token punctuation">,</span> executor<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2.6 è¿½è¸ªåˆ°æºç æŠ½è±¡ç±» <code>MultithreadEventExecutorGroup</code> çš„æ„é€ å™¨æ–¹æ³• <code>MultithreadEventExecutorGroup</code> æ‰æ˜¯ <code>NioEventLoopGroup</code> çœŸæ­£çš„æ„é€ æ–¹æ³•ï¼Œè¿™é‡Œå¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•ï¼Œä½¿ç”¨äº†è®¾è®¡æ¨¡å¼çš„æ¨¡æ¿æ¨¡å¼ï¼ˆå¯çœ‹æˆ‘å½•åˆ¶è§†é¢‘ï¼‰ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å°±éœ€è¦å¥½å¥½åˆ†æ <code>MultithreadEventExecutorGroup</code> æ–¹æ³•äº†</p><p>2.7 åˆ†æ <code>MultithreadEventExecutorGroup</code></p><p>å‚æ•°è¯´æ˜ï¼š</p><ul><li><code>@param nThreads</code> ä½¿ç”¨çš„çº¿ç¨‹æ•°ï¼Œé»˜è®¤ä¸º <code>core * 2</code>ã€å¯ä»¥è¿½è¸ªæºç ã€‘</li><li><code>@param executor</code> æ‰§è¡Œå™¨:å¦‚æœä¼ å…¥ <code>null</code>, åˆ™é‡‡ç”¨ <code>Netty</code> é»˜è®¤çš„çº¿ç¨‹å·¥å‚å’Œé»˜è®¤çš„æ‰§è¡Œå™¨ <code>ThreadPerTaskExecutor</code></li><li><code>@param chooserFactory</code> å•ä¾‹ <code>new DefaultEventExecutorChooserFactory()</code></li><li><code>@param args args</code> åœ¨åˆ›å»ºæ‰§è¡Œå™¨çš„æ—¶å€™ä¼ å…¥å›ºå®šå‚æ•°</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">protected</span> <span class="token class-name">MultithreadEventExecutorGroup</span><span class="token punctuation">(</span><span class="token keyword">int</span> nThreads<span class="token punctuation">,</span> <span class="token class-name">Executor</span> executor<span class="token punctuation">,</span>
                                        <span class="token class-name">EventExecutorChooserFactory</span> chooserFactory<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nThreads <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;nThreads: %d (expected: &gt; 0)&quot;</span><span class="token punctuation">,</span> nThreads<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>executor <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// å¦‚æœä¼ å…¥çš„æ‰§è¡Œå™¨æ˜¯ç©ºçš„åˆ™é‡‡ç”¨é»˜è®¤çš„çº¿ç¨‹å·¥å‚å’Œé»˜è®¤çš„æ‰§è¡Œå™¨</span>
        executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPerTaskExecutor</span><span class="token punctuation">(</span><span class="token function">newDefaultThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// åˆ›å»ºæŒ‡å®šçº¿ç¨‹æ•°çš„æ‰§è¡Œå™¨æ•°ç»„</span>
    children <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventExecutor</span><span class="token punctuation">[</span>nThreads<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// åˆå§‹åŒ–çº¿ç¨‹æ•°ç»„</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nThreads<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// åˆ›å»º new NioEventLoop</span>
            children<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newChild</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            success <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// TODO: Think about if this is a good exception type</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;failed to create a child event loop&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œä¼˜é›…å…³é—­</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> i<span class="token punctuation">;</span> j <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    children<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> i<span class="token punctuation">;</span> j <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">EventExecutor</span> e <span class="token operator">=</span> children<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">.</span><span class="token function">isTerminated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            e<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> interrupted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// Let the caller handle the interruption.</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    chooser <span class="token operator">=</span> chooserFactory<span class="token punctuation">.</span><span class="token function">newChooser</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token class-name">FutureListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> terminationListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> future<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>terminatedChildren<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                terminationFuture<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ä¸ºæ¯ä¸€ä¸ªå•ä¾‹çº¿ç¨‹æ± æ·»åŠ ä¸€ä¸ªå…³é—­ç›‘å¬å™¨</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">EventExecutor</span> e<span class="token operator">:</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">terminationFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>terminationListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EventExecutor</span><span class="token punctuation">&gt;</span></span> childrenSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EventExecutor</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//å°†æ‰€æœ‰çš„å•ä¾‹çº¿ç¨‹æ± æ·»åŠ åˆ°ä¸€ä¸ª HashSet ä¸­ã€‚</span>
    <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>childrenSet<span class="token punctuation">,</span> children<span class="token punctuation">)</span><span class="token punctuation">;</span>
    readonlyChildren <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableSet</span><span class="token punctuation">(</span>childrenSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š</p><ol><li>å¦‚æœ <code>executor</code> æ˜¯ <code>null</code>ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤çš„ <code>ThreadPerTaskExecutor</code>ï¼Œä½¿ç”¨ <code>Netty</code> é»˜è®¤çš„çº¿ç¨‹å·¥å‚ã€‚</li><li>æ ¹æ®ä¼ å…¥çš„çº¿ç¨‹æ•°ï¼ˆ<code>CPU * 2</code>ï¼‰åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼ˆå•ä¾‹çº¿ç¨‹æ± ï¼‰æ•°ç»„ã€‚</li><li>å¾ªç¯å¡«å……æ•°ç»„ä¸­çš„å…ƒç´ ã€‚å¦‚æœå¼‚å¸¸ï¼Œåˆ™å…³é—­æ‰€æœ‰çš„å•ä¾‹çº¿ç¨‹æ± ã€‚</li><li>æ ¹æ®çº¿ç¨‹é€‰æ‹©å·¥å‚åˆ›å»ºä¸€ä¸ªçº¿ç¨‹é€‰æ‹©å™¨ã€‚</li><li>ä¸ºæ¯ä¸€ä¸ªå•ä¾‹çº¿ç¨‹æ± æ·»åŠ ä¸€ä¸ªå…³é—­ç›‘å¬å™¨ã€‚</li><li>å°†æ‰€æœ‰çš„å•ä¾‹çº¿ç¨‹æ± æ·»åŠ åˆ°ä¸€ä¸ª <code>HashSet</code> ä¸­ã€‚</li></ol><p><strong>3. ServerBootstrap åˆ›å»ºå’Œæ„é€ è¿‡ç¨‹</strong></p><p>3.1 <code>ServerBootstrap</code> æ˜¯ä¸ªç©ºæ„é€ ï¼Œä½†æ˜¯æœ‰é»˜è®¤çš„æˆå‘˜å˜é‡</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> childOptions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttributeKey</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> childAttrs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttributeKey</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// config å¯¹è±¡ï¼Œä¼šåœ¨åé¢èµ·å¾ˆå¤§ä½œç”¨</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ServerBootstrapConfig</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrapConfig</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">EventLoopGroup</span> childGroup<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">ChannelHandler</span> childHandler<span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3.2 åˆ†æä¸€ä¸‹ <code>ServerBootstrap</code> åŸºæœ¬ä½¿ç”¨æƒ…å†µ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_BACKLOG</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoggingHandler</span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sslCtx <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>sslCtx<span class="token punctuation">.</span><span class="token function">newHandler</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//p.addLast(new LoggingHandler(LogLevel.INFO));</span>
                p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EchoServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜:</p><ol><li>é“¾å¼è°ƒç”¨ï¼š<code>group</code> æ–¹æ³•ï¼Œå°† <code>boss</code> å’Œ <code>worker</code> ä¼ å…¥ï¼Œ<code>boss</code> èµ‹å€¼ç»™ <code>parentGroup</code> å±æ€§, <code>worker</code> èµ‹å€¼ç»™ <code>childGroup</code> å±æ€§ã€‚</li><li><code>channel</code> æ–¹æ³•ä¼ å…¥ <code>NioServerSocketChannelclass</code> å¯¹è±¡ã€‚ä¼šæ ¹æ®è¿™ä¸ª <code>class</code> åˆ›å»º <code>channel</code> å¯¹è±¡ã€‚</li><li><code>option</code> æ–¹æ³•ä¼ å…¥ <code>TCP</code> å‚æ•°ï¼Œæ”¾åœ¨ä¸€ä¸ª <code>LinkedHashMap</code> ä¸­ã€‚</li><li><code>handler</code> æ–¹æ³•ä¼ å…¥ä¸€ä¸ª <code>handler</code> ä¸­ï¼Œè¿™ä¸ª <code>hanlder</code> åªä¸“å±äº <code>ServerSocketChannel</code> è€Œä¸æ˜¯ <code>SocketChannel</code>ã€‚</li><li><code>childHandler</code> ä¼ å…¥ä¸€ä¸ª <code>hanlder</code>ï¼Œè¿™ä¸ª <code>handler</code> å°†ä¼šåœ¨æ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥çš„æ—¶å€™è°ƒç”¨ã€‚ä¾› <code>SocketChannel</code> ä½¿ç”¨ã€‚</li></ol><p><strong>4. ç»‘å®šç«¯å£çš„åˆ†æ</strong></p><p>4.1 æœåŠ¡å™¨å°±æ˜¯åœ¨è¿™ä¸ª <code>bind</code> æ–¹æ³•é‡Œå¯åŠ¨å®Œæˆçš„ 4.2 <code>bind</code> æ–¹æ³•ä»£ç ,è¿½è¸ªåˆ°åˆ›å»ºäº†ä¸€ä¸ªç«¯å£å¯¹è±¡ï¼Œå¹¶åšäº†ä¸€äº›ç©ºåˆ¤æ–­ï¼Œæ ¸å¿ƒä»£ç  <code>doBind</code>ï¼Œæˆ‘ä»¬çœ‹çœ‹</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>localAddress <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">&quot;localAddress&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">doBind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4.3 <code>doBind</code> æºç å‰–æï¼Œæ ¸å¿ƒæ˜¯ä¸¤ä¸ªæ–¹æ³• <code>initAndRegister</code> å’Œ <code>doBind0</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">ChannelFuture</span> <span class="token function">doBind</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> regFuture <span class="token operator">=</span> <span class="token function">initAndRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Channel</span> channel <span class="token operator">=</span> regFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> regFuture<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// At this point we know that the registration was complete and successful.</span>
        <span class="token class-name">ChannelPromise</span> promise <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">newPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//============================================</span>
        <span class="token comment">//è¯´æ˜:æ‰§è¡ŒdoBind0æ–¹æ³•ï¼Œå®Œæˆå¯¹ç«¯å£çš„ç»‘å®š</span>
        <span class="token comment">//============================================</span>
        <span class="token function">doBind0</span><span class="token punctuation">(</span>regFuture<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Registration future is almost always fulfilled already, but just in case it&#39;s not.</span>
        <span class="token keyword">final</span> <span class="token class-name">PendingRegistrationPromise</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PendingRegistrationPromise</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        regFuture<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> future<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token class-name">Throwable</span> cause <span class="token operator">=</span> future<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cause <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Registration on the EventLoop failed so fail the ChannelPromise directly to not cause an</span>
                    <span class="token comment">// IllegalStateException once we try to access the EventLoop of the Channel.</span>
                    promise<span class="token punctuation">.</span><span class="token function">setFailure</span><span class="token punctuation">(</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Registration was successful, so set the correct executor to use.</span>
                    <span class="token comment">// See https://github.com/netty/netty/issues/2586</span>
                    promise<span class="token punctuation">.</span><span class="token function">registered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token function">doBind0</span><span class="token punctuation">(</span>regFuture<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4.4 åˆ†æè¯´æ˜ <code>initAndRegister</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> <span class="token function">initAndRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        channel <span class="token operator">=</span> channelFactory<span class="token punctuation">.</span><span class="token function">newChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token doc-comment comment">/**
         * è¯´æ˜ï¼šchannelFactory.newChannel() æ–¹æ³•çš„ä½œç”¨é€šè¿‡ ServerBootstrap çš„é€šé“å·¥å‚åå°„åˆ›å»ºä¸€ä¸ª NioServerSocketChannel,å…·ä½“è¿½è¸ªæºç å¯ä»¥å¾—åˆ°ä¸‹é¢ç»“è®º
         * (1)é€šè¿‡ NIO çš„ SelectorProvider çš„ openServerSocketChannel æ–¹æ³•å¾—åˆ° JDK çš„ channelã€‚ç›®çš„æ˜¯è®© Netty åŒ…è£… JDK çš„ channelã€‚
         * (2)åˆ›å»ºäº†ä¸€ä¸ªå”¯ä¸€çš„ ChannelIdï¼Œåˆ›å»ºäº†ä¸€ä¸ª NioMessageUnsafeï¼Œç”¨äºæ“ä½œæ¶ˆæ¯ï¼Œåˆ›å»ºäº†ä¸€ä¸ª DefaultChannelPipeline ç®¡é“ï¼Œæ˜¯ä¸ªåŒå‘é“¾è¡¨ç»“æ„ï¼Œç”¨äºè¿‡æ»¤æ‰€æœ‰çš„è¿›å‡ºçš„æ¶ˆæ¯ã€‚
         * (3)åˆ›å»ºäº†ä¸€ä¸ª NioServerSocketChannelConfig å¯¹è±¡ï¼Œç”¨äºå¯¹å¤–å±•ç¤ºä¸€äº›é…ç½®ã€‚ 
         
         * channel = channelFactory.newChannel();//NioServerSocketChannel

         * è¯´æ˜ï¼šinit åˆå§‹åŒ–è¿™ä¸ª NioServerSocketChannelï¼Œå…·ä½“è¿½è¸ªæºç å¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“è®º
         * (1) init æ–¹æ³•ï¼Œè¿™æ˜¯ä¸ªæŠ½è±¡æ–¹æ³• (AbstractBootstrapç±»çš„ï¼‰ï¼Œç”±ServerBootstrapå®ç°ï¼ˆå¯ä»¥è¿½ä¸€ä¸‹æºç //setChannelOptions(channel,options,logger);ï¼‰ã€‚
         * (2)è®¾ç½® NioServerSocketChannel çš„ TCP å±æ€§ã€‚
         * (3)ç”±äº LinkedHashMap æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œä½¿ç”¨åŒæ­¥è¿›è¡Œå¤„ç†ã€‚
         * (4)å¯¹ NioServerSocketChannel çš„ ChannelPipeline æ·»åŠ  ChannelInitializer å¤„ç†å™¨ã€‚
         * (5)å¯ä»¥çœ‹å‡ºï¼Œinit çš„æ–¹æ³•çš„æ ¸å¿ƒä½œç”¨åœ¨å’Œ ChannelPipeline ç›¸å…³ã€‚
         * (6)ä» NioServerSocketChannel çš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œpipeline æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¹¶ä¸”ï¼Œä»–æœ¬èº«å°±åˆå§‹åŒ–äº† head å’Œ tailï¼Œè¿™é‡Œè°ƒç”¨äº†ä»–çš„ addLast æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å°†æ•´ä¸ª handler æ’å…¥åˆ° tail çš„å‰é¢ï¼Œå› ä¸º tail æ°¸è¿œä¼šåœ¨åé¢ï¼Œéœ€è¦åšä¸€äº›ç³»ç»Ÿçš„å›ºå®šå·¥ä½œã€‚
         */</span>
        <span class="token function">init</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>channel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            channel<span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeForcibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultChannelPromise</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token class-name">GlobalEventExecutor</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFailure</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultChannelPromise</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FailedChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">GlobalEventExecutor</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFailure</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">ChannelFuture</span> regFuture <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">isRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            channel<span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeForcibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> regFuture<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š</p><ol><li>åŸºæœ¬è¯´æ˜ï¼š<code>initAndRegister()</code> åˆå§‹åŒ– <code>NioServerSocketChannel</code> é€šé“å¹¶æ³¨å†Œå„ä¸ª <code>handler</code>ï¼Œè¿”å›ä¸€ä¸ª <code>future</code>ã€‚</li><li>é€šè¿‡ <code>ServerBootstrap</code> çš„é€šé“å·¥å‚åå°„åˆ›å»ºä¸€ä¸ª <code>NioServerSocketChannel</code>ã€‚</li><li><code>init</code> åˆå§‹åŒ–è¿™ä¸ª <code>NioServerSocketChannel</code>ã€‚</li><li><code>config().group().register(channel)</code> é€šè¿‡ <code>ServerBootstrap</code> çš„ <code>bossGroup</code> æ³¨å†Œ <code>NioServerSocketChannel</code>ã€‚</li><li>æœ€åï¼Œè¿”å›è¿™ä¸ªå¼‚æ­¥æ‰§è¡Œçš„å ä½ç¬¦å³ <code>regFuture</code>ã€‚</li></ol><p>4.5 <code>init</code> æ–¹æ³•ä¼šè°ƒç”¨ <code>addLast</code>ï¼Œç°åœ¨è¿›å…¥åˆ° <code>addLast</code> æ–¹æ³•å†…æŸ¥çœ‹</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">EventExecutorGroup</span> group<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> newCtx<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">checkMultiplicity</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        newCtx <span class="token operator">=</span> <span class="token function">newContext</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> <span class="token function">filterName</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addLast0</span><span class="token punctuation">(</span>newCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registered<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            newCtx<span class="token punctuation">.</span><span class="token function">setAddPending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">callHandlerCallbackLater</span><span class="token punctuation">(</span>newCtx<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> newCtx<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>executor<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">callHandlerAddedInEventLoop</span><span class="token punctuation">(</span>newCtx<span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">callHandlerAdded0</span><span class="token punctuation">(</span>newCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š</p><ol><li><code>addLast</code> æ–¹æ³•ï¼Œåœ¨ <code>DefaultChannelPipeline</code> ç±»ä¸­</li><li><code>addLast</code> æ–¹æ³•è¿™å°±æ˜¯ <code>pipeline</code> æ–¹æ³•çš„æ ¸å¿ƒ</li><li>æ£€æŸ¥è¯¥ <code>handler</code> æ˜¯å¦ç¬¦åˆæ ‡å‡†ã€‚</li><li>åˆ›å»ºä¸€ä¸ª <code>AbstractChannelHandlerContext</code> å¯¹è±¡ï¼Œè¿™é‡Œè¯´ä¸€ä¸‹ï¼Œ<code>ChannelHandlerContext</code> å¯¹è±¡æ˜¯ <code>ChannelHandler</code> å’Œ <code>ChannelPipeline</code> ä¹‹é—´çš„å…³è”ï¼Œæ¯å½“æœ‰ <code>ChannelHandler</code> æ·»åŠ åˆ° <code>Pipeline</code> ä¸­æ—¶ï¼Œéƒ½ä¼šåˆ›å»º <code>Context</code>ã€‚<code>Context</code> çš„ä¸»è¦åŠŸèƒ½æ˜¯ç®¡ç†ä»–æ‰€å…³è”çš„ <code>Handler</code> å’ŒåŒä¸€ä¸ª <code>Pipeline</code> ä¸­çš„å…¶ä»– <code>Handler</code> ä¹‹é—´çš„äº¤äº’ã€‚</li><li>å°† <code>Context</code> æ·»åŠ åˆ°é“¾è¡¨ä¸­ã€‚ä¹Ÿå°±æ˜¯è¿½åŠ åˆ° <code>tail</code> èŠ‚ç‚¹çš„å‰é¢ã€‚</li><li>æœ€åï¼ŒåŒæ­¥æˆ–è€…å¼‚æ­¥æˆ–è€…æ™šç‚¹å¼‚æ­¥çš„è°ƒç”¨ <code>callHandlerAdded0</code> æ–¹æ³•</li></ol><p>4.6 å‰é¢è¯´äº† <code>dobind</code> æ–¹æ³•æœ‰ <code>2</code> ä¸ªé‡è¦çš„æ­¥éª¤ï¼Œ<code>initAndRegister</code> è¯´å®Œï¼Œæ¥ä¸‹æ¥çœ‹ <code>doBind0</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">doBind0</span><span class="token punctuation">(</span>
        <span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> regFuture<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// This method is invoked before channelRegistered() is triggered.  Give user handlers a chance to set up</span>
    <span class="token comment">// the pipeline in its channelRegistered() implementation.</span>
    channel<span class="token punctuation">.</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//bindæ–¹æ³•è¿™é‡Œä¸‹æ–­ç‚¹ï¼Œè¿™é‡Œä¸‹æ–­ç‚¹ï¼Œæ¥ç©!!</span>
                channel<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token class-name">ChannelFutureListener</span><span class="token punctuation">.</span><span class="token constant">CLOSE_ON_FAILURE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                promise<span class="token punctuation">.</span><span class="token function">setFailure</span><span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š</p><ol><li>è¯¥æ–¹æ³•çš„å‚æ•°ä¸º <code>initAndRegister</code> çš„ <code>future</code>ï¼Œ<code>NioServerSocketChannel</code>ï¼Œç«¯å£åœ°å€ï¼Œ<code>NioServerSocketChannel</code> çš„ <code>promise</code></li><li>è¿™é‡Œå°±å¯ä»¥æ ¹æ®å‰é¢ä¸‹çš„æ–­ç‚¹ï¼Œä¸€ç›´ <code>debug</code>ï¼š</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// å°†è°ƒç”¨ LoggingHandler çš„ invokeBind æ–¹æ³•,æœ€åä¼šè¿½åˆ°</span>
<span class="token comment">// DefaultChannelPipeline ç±»çš„ bind</span>
<span class="token comment">// ç„¶åè¿›å…¥åˆ° unsafe.bind æ–¹æ³• debugï¼Œæ³¨æ„è¦è¿½è¸ªåˆ°</span>
<span class="token comment">// unsafe.bindï¼Œè¦ debug ç¬¬äºŒåœˆçš„æ—¶å€™ï¼Œæ‰èƒ½çœ‹åˆ°ã€‚</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> bind <span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    unsafe<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">,</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ç»§ç»­è¿½è¸ª AbstractChannel çš„ </span>

<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> bind <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//....</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token comment">//!!!! å°çº¢æ——å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæœ€ç»ˆçš„æ–¹æ³•å°±æ˜¯ doBind æ–¹æ³•ï¼Œæ‰§è¡ŒæˆåŠŸåï¼Œæ‰§è¡Œé€šé“çš„ fireChannelActive æ–¹æ³•ï¼Œå‘Šè¯‰æ‰€æœ‰çš„ handlerï¼Œå·²ç»æˆåŠŸç»‘å®šã€‚</span>
        <span class="token function">doBind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">safeSetFailure</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">closeIfClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>æœ€ç»ˆ <code>doBind</code> å°±ä¼šè¿½è¸ªåˆ° <code>NioServerSocketChannel</code> çš„ <code>doBind</code>ï¼Œè¯´æ˜ <code>Netty</code> åº•å±‚ä½¿ç”¨çš„æ˜¯ <code>NIO</code></li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> doBind <span class="token punctuation">(</span><span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token function">javaVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">,</span> config<span class="token punctuation">.</span><span class="token function">getBacklog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">,</span> config<span class="token punctuation">.</span><span class="token function">getBacklog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li><p>å›åˆ° <code>bind</code> æ–¹æ³•ï¼ˆ<code>alt + v</code>ï¼‰ï¼Œæœ€åä¸€æ­¥ï¼š<code>safeSetSuccess(promise)</code>ï¼Œå‘Šè¯‰ <code>promise</code> ä»»åŠ¡æˆåŠŸäº†ã€‚å…¶å¯ä»¥æ‰§è¡Œç›‘å¬å™¨çš„æ–¹æ³•äº†ã€‚åˆ°æ­¤æ•´ä¸ªå¯åŠ¨è¿‡ç¨‹å·²ç»ç»“æŸäº†ï¼Œok äº†</p></li><li><p>ç»§ç»­ <code>atl + v</code> æœåŠ¡å™¨å°±å›è¿›å…¥åˆ°ï¼ˆ<code>NioEventLoop</code> ç±»ï¼‰ä¸€ä¸ªå¾ªç¯ä»£ç ï¼Œè¿›è¡Œç›‘å¬</p></li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_10-2-4-netty-å¯åŠ¨è¿‡ç¨‹æ¢³ç†" tabindex="-1"><a class="header-anchor" href="#_10-2-4-netty-å¯åŠ¨è¿‡ç¨‹æ¢³ç†" aria-hidden="true">#</a> 10.2.4 Netty å¯åŠ¨è¿‡ç¨‹æ¢³ç†</h3><ol><li>åˆ›å»º <code>2</code> ä¸ª <code>EventLoopGroup</code> çº¿ç¨‹æ± æ•°ç»„ã€‚æ•°ç»„é»˜è®¤å¤§å° <code>CPU * 2</code>ï¼Œæ–¹ä¾¿ <code>chooser</code> é€‰æ‹©çº¿ç¨‹æ± æ—¶æé«˜æ€§èƒ½</li><li><code>BootStrap</code> å°† <code>boss</code> è®¾ç½®ä¸º <code>group</code> å±æ€§ï¼Œå°† <code>worker</code> è®¾ç½®ä¸º <code>childer</code> å±æ€§</li><li>é€šè¿‡ <code>bind</code> æ–¹æ³•å¯åŠ¨ï¼Œå†…éƒ¨é‡è¦æ–¹æ³•ä¸º <code>initAndRegister</code> å’Œ <code>dobind</code> æ–¹æ³•</li><li><code>initAndRegister</code> æ–¹æ³•ä¼šåå°„åˆ›å»º <code>NioServerSocketChannel</code> åŠå…¶ç›¸å…³çš„ <code>NIO</code> çš„å¯¹è±¡ï¼Œ<code>pipeline</code>ï¼Œ<code>unsafe</code>ï¼ŒåŒæ—¶ä¹Ÿä¸º <code>pipeline</code> åˆå§‹äº† <code>head</code> èŠ‚ç‚¹å’Œ <code>tail</code> èŠ‚ç‚¹ã€‚</li><li>åœ¨ <code>register0</code> æ–¹æ³•æˆåŠŸä»¥åè°ƒç”¨åœ¨ <code>dobind</code> æ–¹æ³•ä¸­è°ƒç”¨ <code>doBind0</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨ <code>NioServerSocketChannel</code> çš„ <code>doBind</code> æ–¹æ³•å¯¹ <code>JDK</code> çš„ <code>channel</code> å’Œç«¯å£è¿›è¡Œç»‘å®šï¼Œå®Œæˆ <code>Netty</code> æœåŠ¡å™¨çš„æ‰€æœ‰å¯åŠ¨ï¼Œå¹¶å¼€å§‹ç›‘å¬è¿æ¥äº‹ä»¶ã€‚</li></ol><h2 id="_10-3-netty-æ¥å—è¯·æ±‚è¿‡ç¨‹æºç å‰–æ" tabindex="-1"><a class="header-anchor" href="#_10-3-netty-æ¥å—è¯·æ±‚è¿‡ç¨‹æºç å‰–æ" aria-hidden="true">#</a> 10.3 Netty æ¥å—è¯·æ±‚è¿‡ç¨‹æºç å‰–æ</h2><h3 id="_10-3-1-æºç å‰–æç›®çš„" tabindex="-1"><a class="header-anchor" href="#_10-3-1-æºç å‰–æç›®çš„" aria-hidden="true">#</a> 10.3.1 æºç å‰–æç›®çš„</h3><ol><li>æœåŠ¡å™¨å¯åŠ¨åè‚¯å®šæ˜¯è¦æ¥å—å®¢æˆ·ç«¯è¯·æ±‚å¹¶è¿”å›å®¢æˆ·ç«¯æƒ³è¦çš„ä¿¡æ¯çš„ï¼Œä¸‹é¢æºç åˆ†æ <code>Netty</code> åœ¨å¯åŠ¨ä¹‹åæ˜¯å¦‚ä½•æ¥å—å®¢æˆ·ç«¯è¯·æ±‚çš„</li><li>åœ¨ <code>io.netty.example</code> åŒ…ä¸‹</li></ol><h3 id="_10-3-2-æºç å‰–æ" tabindex="-1"><a class="header-anchor" href="#_10-3-2-æºç å‰–æ" aria-hidden="true">#</a> 10.3.2 æºç å‰–æ</h3><p>è¯´æ˜ï¼š</p><ol><li>ä»ä¹‹å‰æœåŠ¡å™¨å¯åŠ¨çš„æºç ä¸­ï¼Œæˆ‘ä»¬å¾—çŸ¥ï¼ŒæœåŠ¡å™¨æœ€ç»ˆæ³¨å†Œäº†ä¸€ä¸ª <code>Accept</code> äº‹ä»¶ç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥ã€‚æˆ‘ä»¬ä¹ŸçŸ¥é“ï¼Œ<code>NioServerSocketChannel</code> å°†è‡ªå·±æ³¨å†Œåˆ°äº† <code>boss</code> å•ä¾‹çº¿ç¨‹æ± ï¼ˆ<code>reactor</code> çº¿ç¨‹ï¼‰ä¸Šï¼Œä¹Ÿå°±æ˜¯ <code>EventLoop</code>ã€‚</li><li>å…ˆç®€å•è¯´ä¸‹ <code>EventLoop</code> çš„é€»è¾‘(åé¢æˆ‘ä»¬è¯¦ç»†è®²è§£ <code>EventLoop</code>)</li></ol><p><code>EventLoop</code> çš„ä½œç”¨æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œè€Œè¿™ä¸ªå¾ªç¯ä¸­åš 3 ä»¶äº‹æƒ…ï¼š</p><ol><li>æœ‰æ¡ä»¶çš„ç­‰å¾… <code>NIO</code> äº‹ä»¶ã€‚</li><li>å¤„ç† <code>NIO</code> äº‹ä»¶ã€‚</li><li>å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</li><li>ä»ç”¨å‰é¢çš„é¡¹ç›®æ¥åˆ†æï¼šè¿›å…¥åˆ° <code>NioEventLoop</code> æºç ä¸­åï¼Œåœ¨ <code>private void processSelectedKey(SelectionKey k, AbstractNioChannel ch)</code> æ–¹æ³•å¼€å§‹è°ƒè¯•æœ€ç»ˆæˆ‘ä»¬è¦åˆ†æåˆ° <code>AbstractNioChannel</code> çš„ <code>doBeginRead</code> æ–¹æ³•ï¼Œå½“åˆ°è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œé’ˆå¯¹äºè¿™ä¸ªå®¢æˆ·ç«¯çš„è¿æ¥å°±å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥ç›‘å¬è¯»äº‹ä»¶äº†</li></ol><p>æºç åˆ†æè¿‡ç¨‹</p><ol><li>æ–­ç‚¹ä½ç½® <code>NioEventLoop</code> çš„å¦‚ä¸‹æ–¹æ³• <code>processSelectedKey</code></li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_READ</span> <span class="token operator">|</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> readyOps <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unsafe<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ–­ç‚¹ä½ç½®</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>æ‰§è¡Œæµè§ˆå™¨ <code>http://localhost:8007/</code> ï¼Œå®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚</li><li>ä»çš„æ–­ç‚¹æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<code>readyOps</code> æ˜¯ <code>16</code>ï¼Œä¹Ÿå°±æ˜¯ <code>Accept</code> äº‹ä»¶ã€‚è¯´æ˜æµè§ˆå™¨çš„è¯·æ±‚å·²ç»è¿›æ¥äº†ã€‚</li><li>è¿™ä¸ª <code>unsafe</code> æ˜¯ <code>boss</code> çº¿ç¨‹ä¸­ <code>NioServerSocketChannel</code> çš„ <code>AbstractNioMessageChannel$NioMessageUnsafe</code> å¯¹è±¡ã€‚æˆ‘ä»¬è¿›å…¥åˆ° <code>AbstractNioMessageChannel$NioMessageUnsafe</code> çš„ <code>read</code> æ–¹æ³•ä¸­</li><li><code>read</code> æ–¹æ³•ä»£ç å¹¶åˆ†æ:</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">asserteventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">ChannelConfig</span> config <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> <span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">RecvByteBufAllocator<span class="token punctuation">.</span>Handle</span> allocHandle <span class="token operator">=</span> <span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">recvBufAllocHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    allocHandle<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    booleanclosed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token class-name">Throwable</span> exception <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> localRead <span class="token operator">=</span> <span class="token function">doReadMessages</span><span class="token punctuation">(</span>readBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>localRead <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>localRead <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    closed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                
                allocHandle<span class="token punctuation">.</span><span class="token function">incMessagesRead</span><span class="token punctuation">(</span>localRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>allocHandle<span class="token punctuation">.</span><span class="token function">continueReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            exception <span class="token operator">=</span> t<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">int</span> size <span class="token operator">=</span> readBuf<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            readPending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            pipeline<span class="token punctuation">.</span><span class="token function">fireChannelRead</span><span class="token punctuation">(</span>readBuf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        readBuf<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        allocHandle<span class="token punctuation">.</span><span class="token function">readComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pipeline<span class="token punctuation">.</span><span class="token function">fireChannelReadComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            closed <span class="token operator">=</span> <span class="token function">closeOnReadError</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>

            pipeline<span class="token punctuation">.</span><span class="token function">fireExceptionCaught</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            inputShutdown <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">close</span><span class="token punctuation">(</span><span class="token function">voidPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">//Check if there is a readPending which was not processed yet.</span>
        <span class="token comment">//This could be for two reasons:</span>
        <span class="token comment">//* The user called Channel.read() or ChannelHandlerContext.read() in channelRead(...) method</span>
        <span class="token comment">//* The user called Channel.read() or ChannelHandlerContext.read() in channelReadComplete(...) method</span>
        <span class="token comment">//</span>
        <span class="token comment">// See https://github.com/netty/netty/issues/2254</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>readPending <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>config<span class="token punctuation">.</span><span class="token function">isAutoRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">removeReadOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š 1)æ£€æŸ¥è¯¥ <code>eventloop</code> çº¿ç¨‹æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹ã€‚<code>asserteventLoop().inEventLoop()</code></p><p>2)æ‰§è¡Œ <code>doReadMessages</code> æ–¹æ³•ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ª <code>readBuf</code> å˜é‡ï¼Œè¿™ä¸ªå˜é‡æ˜¯ä¸€ä¸ª <code>List</code>ï¼Œä¹Ÿå°±æ˜¯å®¹å™¨ã€‚</p><p>3)å¾ªç¯å®¹å™¨ï¼Œæ‰§è¡Œ <code>pipeline.fireChannelRead(readBuf.get(i));</code></p><p>4)<code>doReadMessages</code> æ˜¯è¯»å– <code>boss</code> çº¿ç¨‹ä¸­çš„ <code>NioServerSocketChannel</code> æ¥å—åˆ°çš„è¯·æ±‚ã€‚å¹¶æŠŠè¿™äº›è¯·æ±‚æ”¾è¿›å®¹å™¨ï¼Œä¸€ä¼šæˆ‘ä»¬ <code>debug</code> ä¸‹ <code>doReadMessages</code> æ–¹æ³•ã€‚</p><p>5)å¾ªç¯éå†å®¹å™¨ä¸­çš„æ‰€æœ‰è¯·æ±‚ï¼Œè°ƒç”¨ <code>pipeline</code> çš„ <code>fireChannelRead</code> æ–¹æ³•ï¼Œç”¨äºå¤„ç†è¿™äº›æ¥å—çš„è¯·æ±‚æˆ–è€…å…¶ä»–äº‹ä»¶ï¼Œåœ¨ <code>read</code> æ–¹æ³•ä¸­ï¼Œå¾ªç¯è°ƒç”¨ <code>ServerSocket</code> çš„ <code>pipeline</code> çš„ <code>fireChannelRead</code> æ–¹æ³•,å¼€å§‹æ‰§è¡Œç®¡é“ä¸­çš„ <code>handler</code> çš„ <code>ChannelRead</code> æ–¹æ³•ï¼ˆ<code>debug</code> è¿›å…¥ï¼‰</p><ol start="6"><li>è¿½è¸ªä¸€ä¸‹ <code>doReadMessages</code> æ–¹æ³•ï¼Œå°±å¯ä»¥çœ‹å¾—æ›´æ¸…æ™°</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">int</span> doReadMessages <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> buf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">SocketChannel</span> ch <span class="token operator">=</span> <span class="token class-name">SocketUtils</span><span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token function">javaChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">newNioSocketChannel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š 1)é€šè¿‡å·¥å…·ç±»ï¼Œè°ƒç”¨ <code>NioServerSocketChannel</code> å†…éƒ¨å°è£…çš„ <code>serverSocketChannel</code> çš„ <code>accept</code> æ–¹æ³•ï¼Œè¿™æ˜¯ <code>NIO</code> åšæ³•ã€‚</p><p>2)è·å–åˆ°ä¸€ä¸ª <code>JDK</code> çš„ <code>SocketChannel</code>ï¼Œç„¶åï¼Œä½¿ç”¨ <code>NioSocketChannel</code> è¿›è¡Œå°è£…ã€‚æœ€åæ·»åŠ åˆ°å®¹å™¨ä¸­</p><p>3)è¿™æ ·å®¹å™¨ <code>buf</code> ä¸­å°±æœ‰äº† <code>NioSocketChannel</code> ã€å¦‚æœæœ‰å…´è¶£å¯ä»¥è¿½ä¸€ä¸‹ <code>NioSocketChannel</code> æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼Œæˆ‘å°±ä¸è¿½äº†ã€‘</p><ol start="7"><li>å›åˆ° <code>read</code> æ–¹æ³•ï¼Œç»§ç»­åˆ†æå¾ªç¯æ‰§è¡Œ <code>pipeline.fireChannelRead</code> æ–¹æ³•</li></ol><p>1)å‰é¢åˆ†æ <code>doReadMessages</code> æ–¹æ³•çš„ä½œç”¨æ˜¯é€šè¿‡ <code>ServerSocket</code> çš„ <code>accept</code> æ–¹æ³•è·å–åˆ° <code>TCP</code> è¿æ¥ï¼Œç„¶åå°è£…æˆ <code>Netty</code> çš„ <code>NioSocketChannel</code> å¯¹è±¡ã€‚æœ€åæ·»åŠ åˆ°å®¹å™¨ä¸­</p><p>2)åœ¨ <code>read</code> æ–¹æ³•ä¸­ï¼Œå¾ªç¯è°ƒç”¨ <code>ServerSocket</code> çš„ <code>pipeline</code> çš„ <code>fireChannelRead</code> æ–¹æ³•,å¼€å§‹æ‰§è¡Œç®¡é“ä¸­çš„ <code>handler</code> çš„ <code>ChannelRead</code> æ–¹æ³•ï¼ˆ<code>debug</code> è¿›å…¥ï¼‰</p><p>3)ç»è¿‡ <code>dubug</code>ï¼ˆå¤šæ¬¡ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°ä¼šåå¤æ‰§è¡Œå¤šä¸ª <code>handler</code> çš„ <code>ChannelRead</code>ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œ<code>pipeline</code> é‡Œé¢åˆ <code>4</code> ä¸ª <code>handler</code>ï¼Œåˆ†åˆ«æ˜¯ <code>Head</code>ï¼Œ<code>LoggingHandler</code>ï¼Œ<code>ServerBootstrapAcceptor</code>ï¼Œ<code>Tail</code>ã€‚</p><p>4)æˆ‘ä»¬é‡ç‚¹çœ‹çœ‹ <code>ServerBootstrapAcceptor</code>ã€‚<code>debug</code> ä¹‹åï¼Œæ–­ç‚¹ä¼šè¿›å…¥åˆ° <code>ServerBootstrapAcceptor</code> ä¸­æ¥ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ <code>ServerBootstrapAcceptor</code> çš„ <code>channelRead</code> æ–¹æ³•ï¼ˆè¦å¤šæ¬¡ <code>debug</code> æ‰å¯ä»¥ï¼‰</p><p>5)<code>channelRead</code> æ–¹æ³•</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> channelRead <span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Channelchild</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Channel</span><span class="token punctuation">)</span>msg<span class="token punctuation">;</span>
    child<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>childHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setChannelOptions</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> childOptions<span class="token punctuation">,</span> logger<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttributeKey</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">:</span> childAttrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        child<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AttributeKey</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span><span class="token comment">//å°†å®¢æˆ·ç«¯è¿æ¥æ³¨å†Œåˆ° worker çº¿ç¨‹æ± </span>
        childGroup<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuturefuture</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>future<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">forceClose</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> future<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">forceClose</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š 1)<code>msg</code> å¼ºè½¬æˆ <code>Channel</code>ï¼Œå®é™…ä¸Šå°±æ˜¯ <code>NioSocketChannel</code>ã€‚</p><p>2)æ·»åŠ  <code>NioSocketChannel</code> çš„ <code>pipeline</code> çš„ <code>handler</code>ï¼Œå°±æ˜¯æˆ‘ä»¬ <code>main</code> æ–¹æ³•é‡Œé¢è®¾ç½®çš„ <code>childHandler</code> æ–¹æ³•é‡Œçš„ã€‚</p><p>3)è®¾ç½® <code>NioSocketChannel</code> çš„å„ç§å±æ€§ã€‚</p><p>4)å°†è¯¥ <code>NioSocketChannel</code> æ³¨å†Œåˆ° <code>childGroup</code> ä¸­çš„ä¸€ä¸ª <code>EventLoop</code> ä¸Šï¼Œå¹¶æ·»åŠ ä¸€ä¸ªç›‘å¬å™¨ã€‚</p><p>5)è¿™ä¸ª <code>childGroup</code> å°±æ˜¯æˆ‘ä»¬ <code>main</code> æ–¹æ³•åˆ›å»ºçš„æ•°ç»„ <code>workerGroup</code>ã€‚</p><ol start="8"><li>è¿›å…¥ <code>register</code> æ–¹æ³•æŸ¥çœ‹(æ­¥æ­¥è¿½è¸ªä¼šåˆ°)</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> register <span class="token punctuation">(</span><span class="token class-name">EventLoop</span> eventLoop<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AbstractChannel</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventLoop <span class="token operator">=</span> eventLoop<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>eventLoop<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">register0</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        eventLoop<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">register0</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿›å…¥åˆ°è¿™é‡Œ</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// ç»§ç»­è¿›å…¥åˆ°ä¸‹é¢æ–¹æ³•ï¼Œæ‰§è¡Œç®¡é“ä¸­å¯èƒ½å­˜åœ¨çš„ä»»åŠ¡,è¿™é‡Œæˆ‘ä»¬å°±ä¸è¿½äº†</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="9"><li>æœ€ç»ˆä¼šè°ƒç”¨ <code>doBeginRead</code> æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ <code>AbstractNioChannel</code> ç±»çš„æ–¹æ³•</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doBeginRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">//Channel.read() or ChannelHandlerContext.read() was called</span>
    <span class="token keyword">final</span> <span class="token class-name">SelectionKey</span> selectionKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selectionKey<span class="token punctuation">;</span><span class="token comment">//æ–­ç‚¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>selectionKey<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    readPending <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> interestOps <span class="token operator">=</span> selectionKey<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>interestOps<span class="token operator">&amp;</span>readInterestOp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        selectionKey<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span>interestOps <span class="token operator">|</span> readInterestOp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="10"><li>è¿™ä¸ªåœ°æ–¹è°ƒè¯•æ—¶ï¼Œè¯·æŠŠå‰é¢çš„æ–­ç‚¹éƒ½å»æ‰ï¼Œç„¶åå¯åŠ¨æœåŠ¡å™¨å°±ä¼šåœæ­¢åœ¨ <code>doBeginRead</code>ï¼ˆéœ€è¦å…ˆæ”¾è¿‡è¯¥æ–­ç‚¹ï¼Œç„¶åæµè§ˆå™¨è¯·æ±‚ï¼Œæ‰èƒ½çœ‹åˆ°æ•ˆæœï¼‰</li><li>æ‰§è¡Œåˆ°è¿™é‡Œæ—¶ï¼Œé’ˆå¯¹äºè¿™ä¸ªå®¢æˆ·ç«¯çš„è¿æ¥å°±å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥ç›‘å¬è¯»äº‹ä»¶äº†</li></ol><h3 id="_10-3-3-netty-æ¥å—è¯·æ±‚è¿‡ç¨‹æ¢³ç†" tabindex="-1"><a class="header-anchor" href="#_10-3-3-netty-æ¥å—è¯·æ±‚è¿‡ç¨‹æ¢³ç†" aria-hidden="true">#</a> 10.3.3 Netty æ¥å—è¯·æ±‚è¿‡ç¨‹æ¢³ç†</h3><p>æ€»ä½“æµç¨‹ï¼šæ¥å—è¿æ¥ --&gt; åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>NioSocketChannel</code> --&gt; æ³¨å†Œåˆ°ä¸€ä¸ª <code>workerEventLoop</code> ä¸Š --&gt; æ³¨å†Œ <code>selecotRead</code> äº‹ä»¶ã€‚</p><ol><li>æœåŠ¡å™¨è½®è¯¢ <code>Accept</code> äº‹ä»¶ï¼Œè·å–äº‹ä»¶åè°ƒç”¨ <code>unsafe</code> çš„ <code>read</code> æ–¹æ³•ï¼Œè¿™ä¸ª <code>unsafe</code> æ˜¯ <code>ServerSocket</code> çš„å†…éƒ¨ç±»ï¼Œè¯¥æ–¹æ³•å†…éƒ¨ç”± <code>2</code> éƒ¨åˆ†ç»„æˆ</li><li><code>doReadMessages</code> ç”¨äºåˆ›å»º <code>NioSocketChannel</code> å¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…è£… <code>JDK</code> çš„ <code>NioChannel</code> å®¢æˆ·ç«¯ã€‚è¯¥æ–¹æ³•ä¼šåƒåˆ›å»º <code>ServerSocketChanel</code> ç±»ä¼¼åˆ›å»ºç›¸å…³çš„ <code>pipeline</code>ï¼Œ<code>unsafe</code>ï¼Œ<code>config</code></li><li>éšåæ‰§è¡Œæ‰§è¡Œ <code>pipeline.fireChannelRead</code> æ–¹æ³•ï¼Œå¹¶å°†è‡ªå·±ç»‘å®šåˆ°ä¸€ä¸ª <code>chooser</code> é€‰æ‹©å™¨é€‰æ‹©çš„ <code>workerGroup</code> ä¸­çš„ä¸€ä¸ª <code>EventLoop</code>ã€‚å¹¶ä¸”æ³¨å†Œä¸€ä¸ª <code>0</code>ï¼Œè¡¨ç¤ºæ³¨å†ŒæˆåŠŸï¼Œä½†å¹¶æ²¡æœ‰æ³¨å†Œè¯»ï¼ˆ1ï¼‰äº‹ä»¶</li></ol><h2 id="_10-4-pipeline-handler-handlercontext-åˆ›å»ºæºç å‰–æ" tabindex="-1"><a class="header-anchor" href="#_10-4-pipeline-handler-handlercontext-åˆ›å»ºæºç å‰–æ" aria-hidden="true">#</a> 10.4 Pipeline Handler HandlerContext åˆ›å»ºæºç å‰–æ</h2><h3 id="_10-4-1-æºç å‰–æç›®çš„" tabindex="-1"><a class="header-anchor" href="#_10-4-1-æºç å‰–æç›®çš„" aria-hidden="true">#</a> 10.4.1 æºç å‰–æç›®çš„</h3><p><code>Netty</code> ä¸­çš„ <code>ChannelPipeline</code>ã€<code>ChannelHandler</code> å’Œ <code>ChannelHandlerContext</code> æ˜¯éå¸¸æ ¸å¿ƒçš„ç»„ä»¶ï¼Œæˆ‘ä»¬ä»æºç æ¥åˆ†æ <code>Netty</code> æ˜¯å¦‚ä½•è®¾è®¡è¿™ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶çš„ï¼Œå¹¶åˆ†ææ˜¯å¦‚ä½•åˆ›å»ºå’Œåè°ƒå·¥ä½œçš„.</p><h3 id="_10-4-2-æºç å‰–æè¯´æ˜" tabindex="-1"><a class="header-anchor" href="#_10-4-2-æºç å‰–æè¯´æ˜" aria-hidden="true">#</a> 10.4.2 æºç å‰–æè¯´æ˜</h3><p>è¯´æ˜ åˆ†æè¿‡ç¨‹ä¸­ï¼Œæœ‰å¾ˆå¤šçš„å›¾å½¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å‡†å¤‡äº†ä¸€ä¸ªæ–‡æ¡£ï¼Œåœ¨æ–‡æ¡£çš„åŸºç¡€ä¸Šæ¥åšæºç å‰–æ</p><h3 id="_10-4-3-æºç å‰–æ" tabindex="-1"><a class="header-anchor" href="#_10-4-3-æºç å‰–æ" aria-hidden="true">#</a> 10.4.3 æºç å‰–æ</h3><ol><li>ChannelPipeline | ChannelHandler | ChannelHandlerContextä»‹ç» 1.1 ä¸‰è€…å…³ç³»</li></ol><p>1)æ¯å½“ <code>ServerSocket</code> åˆ›å»ºä¸€ä¸ªæ–°çš„è¿æ¥ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ª <code>Socket</code>ï¼Œå¯¹åº”çš„å°±æ˜¯ç›®æ ‡å®¢æˆ·ç«¯ã€‚</p><p>2)æ¯ä¸€ä¸ªæ–°åˆ›å»ºçš„ <code>Socket</code> éƒ½å°†ä¼šåˆ†é…ä¸€ä¸ªå…¨æ–°çš„ <code>ChannelPipeline</code>ï¼ˆä»¥ä¸‹ç®€ç§° <code>pipeline</code>ï¼‰</p><p>3)æ¯ä¸€ä¸ª <code>ChannelPipeline</code> å†…éƒ¨éƒ½å«æœ‰å¤šä¸ª <code>ChannelHandlerContext</code>ï¼ˆä»¥ä¸‹ç®€ç§° <code>Context</code>ï¼‰</p><p>4)ä»–ä»¬ä¸€èµ·ç»„æˆäº†åŒå‘é“¾è¡¨ï¼Œè¿™äº› <code>Context</code> ç”¨äºåŒ…è£…æˆ‘ä»¬è°ƒç”¨ <code>addLast</code> æ–¹æ³•æ—¶æ·»åŠ çš„ <code>ChannelHandler</code>ï¼ˆä»¥ä¸‹ç®€ç§° <code>handler</code>ï¼‰</p><p><img src="https://javablog-image.oss-cn-hangzhou.aliyuncs.com/blog/chapter10_02.png" alt="" loading="lazy"></p><p>1)ä¸Šå›¾ä¸­ï¼š<code>ChannelSocket</code> å’Œ <code>ChannelPipeline</code> æ˜¯ä¸€å¯¹ä¸€çš„å…³è”å…³ç³»ï¼Œè€Œ <code>pipeline</code> å†…éƒ¨çš„å¤šä¸ª <code>Context</code> å½¢æˆäº†é“¾è¡¨ï¼Œ<code>Context</code> åªæ˜¯å¯¹ <code>Handler</code> çš„å°è£…ã€‚ 2)å½“ä¸€ä¸ªè¯·æ±‚è¿›æ¥çš„æ—¶å€™ï¼Œä¼šè¿›å…¥ <code>Socket</code> å¯¹åº”çš„ <code>pipeline</code>ï¼Œå¹¶ç»è¿‡ <code>pipeline</code> æ‰€æœ‰çš„ <code>handler</code>ï¼Œå¯¹ï¼Œå°±æ˜¯è®¾è®¡æ¨¡å¼ä¸­çš„è¿‡æ»¤å™¨æ¨¡å¼ã€‚</p><p>1.2 ChannelPipeline ä½œç”¨åŠè®¾è®¡</p><p>1)<code>pipeline</code> çš„æ¥å£è®¾è®¡</p><p><img src="https://javablog-image.oss-cn-hangzhou.aliyuncs.com/blog/chapter10_03.png" alt="" loading="lazy"></p><p>éƒ¨åˆ†æºç </p><p><img src="https://javablog-image.oss-cn-hangzhou.aliyuncs.com/blog/chapter10_04.png" alt="" loading="lazy"></p><p>å¯ä»¥çœ‹åˆ°è¯¥æ¥å£ç»§æ‰¿äº† <code>inBound</code>ï¼Œ<code>outBound</code>ï¼Œ<code>Iterable</code> æ¥å£ï¼Œè¡¨ç¤ºä»–å¯ä»¥è°ƒç”¨æ•°æ®å‡ºç«™çš„æ–¹æ³•å’Œå…¥ç«™çš„æ–¹æ³•ï¼ŒåŒæ—¶ä¹Ÿèƒ½éå†å†…éƒ¨çš„é“¾è¡¨ï¼Œçœ‹çœ‹ä»–çš„å‡ ä¸ªä»£è¡¨æ€§çš„æ–¹æ³•ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯é’ˆå¯¹ <code>handler</code> é“¾è¡¨çš„æ’å…¥ï¼Œè¿½åŠ ï¼Œåˆ é™¤ï¼Œæ›¿æ¢æ“ä½œï¼Œç±»ä¼¼æ˜¯ä¸€ä¸ª <code>LinkedList</code>ã€‚åŒæ—¶ï¼Œä¹Ÿèƒ½è¿”å› <code>channel</code>ï¼ˆä¹Ÿå°±æ˜¯ <code>socket</code>ï¼‰</p><p>1)åœ¨ <code>pipeline</code> çš„æ¥å£æ–‡æ¡£ä¸Šï¼Œæä¾›äº†ä¸€å¹…å›¾</p><p><img src="https://javablog-image.oss-cn-hangzhou.aliyuncs.com/blog/chapter10_05.png" alt="" loading="lazy"></p><p>å¯¹ä¸Šå›¾çš„è§£é‡Šè¯´æ˜ï¼š *è¿™æ˜¯ä¸€ä¸ª <code>handler</code> çš„ <code>list</code>ï¼Œ<code>handler</code> ç”¨äºå¤„ç†æˆ–æ‹¦æˆªå…¥ç«™äº‹ä»¶å’Œå‡ºç«™äº‹ä»¶ï¼Œ<code>pipeline</code> å®ç°äº†è¿‡æ»¤å™¨çš„é«˜çº§å½¢å¼ï¼Œä»¥ä¾¿ç”¨æˆ·æ§åˆ¶äº‹ä»¶å¦‚ä½•å¤„ç†ä»¥åŠ <code>handler</code> åœ¨ <code>pipeline</code> ä¸­å¦‚ä½•äº¤äº’ã€‚</p><p>*ä¸Šå›¾æè¿°äº†ä¸€ä¸ªå…¸å‹çš„ <code>handler</code> åœ¨ <code>pipeline</code> ä¸­å¤„ç† <code>I/O</code> äº‹ä»¶çš„æ–¹å¼ï¼Œ<code>IO</code> äº‹ä»¶ç”± <code>inboundHandler</code> æˆ–è€… <code>outBoundHandler</code> å¤„ç†ï¼Œå¹¶é€šè¿‡è°ƒç”¨ <code>ChannelHandlerContext.fireChannelRead</code> æ–¹æ³•è½¬å‘ç»™å…¶æœ€è¿‘çš„å¤„ç†ç¨‹åºã€‚</p><p>*å…¥ç«™äº‹ä»¶ç”±å…¥ç«™å¤„ç†ç¨‹åºä»¥è‡ªä¸‹è€Œä¸Šçš„æ–¹å‘å¤„ç†ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚å…¥ç«™å¤„ç†ç¨‹åºé€šå¸¸å¤„ç†ç”±å›¾åº•éƒ¨çš„ <code>I/O</code> çº¿ç¨‹ç”Ÿæˆå…¥ç«™æ•°æ®ã€‚å…¥ç«™æ•°æ®é€šå¸¸ä»å¦‚ <code>SocketChannel.read(ByteBuffer)</code> è·å–ã€‚</p><p>*é€šå¸¸ä¸€ä¸ª <code>pipeline</code> æœ‰å¤šä¸ª <code>handler</code>ï¼Œä¾‹å¦‚ï¼Œä¸€ä¸ªå…¸å‹çš„æœåŠ¡å™¨åœ¨æ¯ä¸ªé€šé“çš„ç®¡é“ä¸­éƒ½ä¼šæœ‰ä»¥ä¸‹å¤„ç†ç¨‹åºåè®®è§£ç å™¨-å°†äºŒè¿›åˆ¶æ•°æ®è½¬æ¢ä¸º <code>Java</code> å¯¹è±¡ã€‚åè®®ç¼–ç å™¨-å°† <code>Java</code> å¯¹è±¡è½¬æ¢ä¸ºäºŒè¿›åˆ¶æ•°æ®ã€‚ä¸šåŠ¡é€»è¾‘å¤„ç†ç¨‹åº-æ‰§è¡Œå®é™…ä¸šåŠ¡é€»è¾‘ï¼ˆä¾‹å¦‚æ•°æ®åº“è®¿é—®ï¼‰</p><p>*ä½ çš„ä¸šåŠ¡ç¨‹åºä¸èƒ½å°†çº¿ç¨‹é˜»å¡ï¼Œä¼šå½±å“ <code>IO</code> çš„é€Ÿåº¦ï¼Œè¿›è€Œå½±å“æ•´ä¸ª <code>Netty</code> ç¨‹åºçš„æ€§èƒ½ã€‚å¦‚æœä½ çš„ä¸šåŠ¡ç¨‹åºå¾ˆå¿«ï¼Œå°±å¯ä»¥æ”¾åœ¨ <code>IO</code> çº¿ç¨‹ä¸­ï¼Œåä¹‹ï¼Œä½ éœ€è¦å¼‚æ­¥æ‰§è¡Œã€‚æˆ–è€…åœ¨æ·»åŠ  <code>handler</code> çš„æ—¶å€™æ·»åŠ ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œä¾‹å¦‚ï¼š</p><p>// ä¸‹é¢è¿™ä¸ªä»»åŠ¡æ‰§è¡Œçš„æ—¶å€™ï¼Œå°†ä¸ä¼šé˜»å¡ <code>IO</code> çº¿ç¨‹ï¼Œæ‰§è¡Œçš„çº¿ç¨‹æ¥è‡ª <code>group</code> çº¿ç¨‹æ± </p><p><code>pipeline.addLast(group, &quot;handler&quot;, new MyBusinessLogicHandler());</code></p><p>1.3 <code>ChannelHandler</code> ä½œç”¨åŠè®¾è®¡</p><p>1)æºç </p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ChannelHandler</span> <span class="token punctuation">{</span>
    <span class="token comment">//å½“æŠŠ ChannelHandler æ·»åŠ åˆ° pipeline æ—¶è¢«è°ƒç”¨</span>
    <span class="token keyword">void</span> <span class="token function">handlerAdded</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
    <span class="token comment">//å½“ä» pipeline ä¸­ç§»é™¤æ—¶è°ƒç”¨</span>
    <span class="token keyword">void</span> <span class="token function">handlerRemoved</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
    <span class="token comment">//å½“å¤„ç†è¿‡ç¨‹ä¸­åœ¨ pipeline å‘ç”Ÿå¼‚å¸¸æ—¶è°ƒç”¨</span>
    <span class="token annotation punctuation">@Deprecated</span>
    <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2)<code>ChannelHandler</code> çš„ä½œç”¨å°±æ˜¯å¤„ç† <code>IO</code> äº‹ä»¶æˆ–æ‹¦æˆª <code>IO</code> äº‹ä»¶ï¼Œå¹¶å°†å…¶è½¬å‘ç»™ä¸‹ä¸€ä¸ªå¤„ç†ç¨‹åº <code>ChannelHandler</code>ã€‚<code>Handler</code> å¤„ç†äº‹ä»¶æ—¶åˆ†å…¥ç«™å’Œå‡ºç«™çš„ï¼Œä¸¤ä¸ªæ–¹å‘çš„æ“ä½œéƒ½æ˜¯ä¸åŒçš„ï¼Œå› æ­¤ï¼Œ<code>Netty</code> å®šä¹‰äº†ä¸¤ä¸ªå­æ¥å£ç»§æ‰¿ <code>ChannelHandler</code></p><p>2)<code>ChannelInboundHandler</code> å…¥ç«™äº‹ä»¶æ¥å£</p><p><img src="https://javablog-image.oss-cn-hangzhou.aliyuncs.com/blog/chapter10_06.png" alt="" loading="lazy"></p><p>*<code>channelActive</code> ç”¨äºå½“ <code>Channel</code> å¤„äºæ´»åŠ¨çŠ¶æ€æ—¶è¢«è°ƒç”¨ï¼›</p><p>*<code>channelRead</code> å½“ä» <code>Channel</code> è¯»å–æ•°æ®æ—¶è¢«è°ƒç”¨ç­‰ç­‰æ–¹æ³•ã€‚</p><p>*ç¨‹åºå‘˜éœ€è¦é‡å†™ä¸€äº›æ–¹æ³•ï¼Œå½“å‘ç”Ÿå…³æ³¨çš„äº‹ä»¶ï¼Œéœ€è¦åœ¨æ–¹æ³•ä¸­å®ç°æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘ï¼Œå› ä¸ºå½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œ<code>Netty</code> ä¼šå›è°ƒå¯¹åº”çš„æ–¹æ³•ã€‚</p><p>3)`ChannelOutboundHandler å‡ºç«™äº‹ä»¶æ¥å£</p><p><img src="https://javablog-image.oss-cn-hangzhou.aliyuncs.com/blog/chapter10_07.png" alt="" loading="lazy"></p><p>*<code>bind</code> æ–¹æ³•ï¼Œå½“è¯·æ±‚å°† <code>Channel</code> ç»‘å®šåˆ°æœ¬åœ°åœ°å€æ—¶è°ƒç”¨</p><p>*<code>close</code> æ–¹æ³•ï¼Œå½“è¯·æ±‚å…³é—­ <code>Channel</code> æ—¶è°ƒç”¨ç­‰ç­‰</p><p>*å‡ºç«™æ“ä½œéƒ½æ˜¯ä¸€äº›è¿æ¥å’Œå†™å‡ºæ•°æ®ç±»ä¼¼çš„æ–¹æ³•ã€‚</p><p>4)<code>ChannelDuplexHandler</code> å¤„ç†å‡ºç«™å’Œå…¥ç«™äº‹ä»¶</p><p><img src="https://javablog-image.oss-cn-hangzhou.aliyuncs.com/blog/chapter10_08.png" alt="" loading="lazy"></p><p>*<code>ChannelDuplexHandler</code> é—´æ¥å®ç°äº†å…¥ç«™æ¥å£å¹¶ç›´æ¥å®ç°äº†å‡ºç«™æ¥å£ã€‚</p><p>*æ˜¯ä¸€ä¸ªé€šç”¨çš„èƒ½å¤ŸåŒæ—¶å¤„ç†å…¥ç«™äº‹ä»¶å’Œå‡ºç«™äº‹ä»¶çš„ç±»ã€‚</p><p>1.4 <code>ChannelHandlerContext</code> ä½œç”¨åŠè®¾è®¡</p><p>1)<code>ChannelHandlerContext</code> <code>UML</code> å›¾</p><p><img src="https://javablog-image.oss-cn-hangzhou.aliyuncs.com/blog/chapter10_09.png" alt="" loading="lazy"></p><p><code>ChannelHandlerContext</code> ç»§æ‰¿äº†å‡ºç«™æ–¹æ³•è°ƒç”¨æ¥å£å’Œå…¥ç«™æ–¹æ³•è°ƒç”¨æ¥å£</p><p>1)<code>ChannelOutboundInvoker</code> å’Œ <code>ChannelInboundInvoker</code> éƒ¨åˆ†æºç </p><p><img src="https://javablog-image.oss-cn-hangzhou.aliyuncs.com/blog/chapter10_10.png" alt="" loading="lazy"></p><p><img src="https://javablog-image.oss-cn-hangzhou.aliyuncs.com/blog/chapter10_11.png" alt="" loading="lazy"></p><p>*è¿™ä¸¤ä¸ª <code>invoker</code> å°±æ˜¯é’ˆå¯¹å…¥ç«™æˆ–å‡ºç«™æ–¹æ³•æ¥çš„ï¼Œå°±æ˜¯åœ¨å…¥ç«™æˆ–å‡ºç«™ <code>handler</code> çš„å¤–å±‚å†åŒ…è£…ä¸€å±‚ï¼Œè¾¾åˆ°åœ¨æ–¹æ³•å‰åæ‹¦æˆªå¹¶åšä¸€äº›ç‰¹å®šæ“ä½œçš„ç›®çš„</p><p>2)<code>ChannelHandlerContext</code> éƒ¨åˆ†æºç </p><p><img src="https://javablog-image.oss-cn-hangzhou.aliyuncs.com/blog/chapter10_12.png" alt="" loading="lazy"></p><p>*<code>ChannelHandlerContext</code> ä¸ä»…ä»…æ—¶ç»§æ‰¿äº†ä»–ä»¬ä¸¤ä¸ªçš„æ–¹æ³•ï¼ŒåŒæ—¶ä¹Ÿå®šä¹‰äº†ä¸€äº›è‡ªå·±çš„æ–¹æ³•</p><p>*è¿™äº›æ–¹æ³•èƒ½å¤Ÿè·å– <code>Context</code> ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­å¯¹åº”çš„æ¯”å¦‚ <code>channel</code>ï¼Œ<code>executor</code>ï¼Œ<code>handler</code>ï¼Œ<code>pipeline</code>ï¼Œå†…å­˜åˆ†é…å™¨ï¼Œå…³è”çš„ <code>handler</code> æ˜¯å¦è¢«åˆ é™¤ã€‚</p><p>*<code>Context</code> å°±æ˜¯åŒ…è£…äº† <code>handler</code> ç›¸å…³çš„ä¸€åˆ‡ï¼Œä»¥æ–¹ä¾¿ <code>Context</code> å¯ä»¥åœ¨ <code>pipeline</code> æ–¹ä¾¿çš„æ“ä½œ <code>handler</code></p><p>2.ChannelPipeline | ChannelHandler | ChannelHandlerContext</p><p>åˆ›å»ºè¿‡ç¨‹åˆ†ä¸º <code>3</code> ä¸ªæ­¥éª¤æ¥çœ‹åˆ›å»ºçš„è¿‡ç¨‹ï¼š</p><p>*ä»»ä½•ä¸€ä¸ª <code>ChannelSocket</code> åˆ›å»ºçš„åŒæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ª <code>pipeline</code>ã€‚</p><p>*å½“ç”¨æˆ·æˆ–ç³»ç»Ÿå†…éƒ¨è°ƒç”¨ <code>pipeline</code> çš„ <code>add</code></p><p>*** æ–¹æ³•æ·»åŠ  <code>handler</code> æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªåŒ…è£…è¿™ <code>handler</code> çš„ <code>Context</code>ã€‚</p><p>*è¿™äº› <code>Context</code> åœ¨ <code>pipeline</code> ä¸­ç»„æˆäº†åŒå‘é“¾è¡¨ã€‚</p><p>2.1 <code>Socket</code> åˆ›å»ºçš„æ—¶å€™åˆ›å»º <code>pipeline</code> åœ¨ <code>SocketChannel</code> çš„æŠ½è±¡çˆ¶ç±» <code>AbstractChannel</code> çš„æ„é€ æ–¹æ³•ä¸­</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">AbstractChannel</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token operator">=</span>parent<span class="token punctuation">;</span><span class="token comment">//æ–­ç‚¹æµ‹è¯•</span>
    id <span class="token operator">=</span> <span class="token function">newId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    unsafe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pipeline <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChannelPipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Debug</code> ä¸€ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°ä»£ç ä¼šæ‰§è¡Œåˆ°è¿™é‡Œï¼Œç„¶åç»§ç»­è¿½è¸ªåˆ°</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">DefaultChannelPipeline</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>channel <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token string">&quot;channel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    succeededFuture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SucceededChannelFuture</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    voidPromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoidChannelPromise</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tail <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TailContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeadContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head<span class="token punctuation">.</span>next <span class="token operator">=</span> tail<span class="token punctuation">;</span>
    tail<span class="token punctuation">.</span>prev <span class="token operator">=</span> head<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š</p><p>1ï¼‰å°† <code>channel</code> èµ‹å€¼ç»™ <code>channel</code> å­—æ®µï¼Œç”¨äº <code>pipeline</code> æ“ä½œ <code>channel</code>ã€‚</p><p>2ï¼‰åˆ›å»ºä¸€ä¸ª <code>future</code> å’Œ <code>promise</code>ï¼Œç”¨äºå¼‚æ­¥å›è°ƒä½¿ç”¨ã€‚</p><p>3ï¼‰åˆ›å»ºä¸€ä¸ª <code>inbound</code> çš„ <code>tailContext</code>ï¼Œåˆ›å»ºä¸€ä¸ªæ—¢æ˜¯ <code>inbound</code> ç±»å‹åˆæ˜¯ <code>outbound</code> ç±»å‹çš„ <code>headContext</code>ã€‚</p><p>4ï¼‰æœ€åï¼Œå°†ä¸¤ä¸ª <code>Context</code> äº’ç›¸è¿æ¥ï¼Œå½¢æˆåŒå‘é“¾è¡¨ã€‚</p><p>5ï¼‰<code>tailContext</code> å’Œ <code>HeadContext</code> éå¸¸çš„é‡è¦ï¼Œæ‰€æœ‰ <code>pipeline</code> ä¸­çš„äº‹ä»¶éƒ½ä¼šæµç»ä»–ä»¬ï¼Œ</p><p>2.2 åœ¨ add<strong>æ·»åŠ å¤„ç†å™¨çš„æ—¶å€™åˆ›å»ºContext</strong>çœ‹ä¸‹ <code>DefaultChannelPipeline</code> çš„ <code>addLast</code> æ–¹æ³•å¦‚ä½•åˆ›å»ºçš„ <code>Context</code>ï¼Œä»£ç å¦‚ä¸‹</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">EventExecutorGroup</span> executor<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> handlers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handlers <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//æ–­ç‚¹</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">&quot;handlers&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> h <span class="token operator">:</span> handlers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">addLast</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç»§ç»­ Debug</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">EventExecutorGroup</span> group<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> newCtx<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">checkMultiplicity</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

        newCtx <span class="token operator">=</span> <span class="token function">newContext</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> <span class="token function">filterName</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addLast0</span><span class="token punctuation">(</span>newCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//If the registered is false it means that the channel was not registered on an eventloop yet.</span>
        <span class="token comment">//In this case we add the context to the pipeline and add a task that will call</span>
        <span class="token comment">//ChannelHandler.handlerAdded(...) once the channel is registered.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registered<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            newCtx<span class="token punctuation">.</span><span class="token function">setAddPending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">callHandlerCallbackLater</span><span class="token punctuation">(</span>newCtx<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> newCtx<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>executor<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            newCtx<span class="token punctuation">.</span><span class="token function">setAddPending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> run <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">callHandlerAdded0</span><span class="token punctuation">(</span>newCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">callHandlerAdded0</span><span class="token punctuation">(</span>newCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ 1)<code>pipeline</code> æ·»åŠ  <code>handler</code>ï¼Œå‚æ•°æ˜¯çº¿ç¨‹æ± ï¼Œ<code>name</code> æ˜¯ <code>null</code>ï¼Œ<code>handler</code> æ˜¯æˆ‘ä»¬æˆ–è€…ç³»ç»Ÿä¼ å…¥çš„ <code>handler</code>ã€‚<code>Netty</code> ä¸ºäº†é˜²æ­¢å¤šä¸ªçº¿ç¨‹å¯¼è‡´å®‰å…¨é—®é¢˜ï¼ŒåŒæ­¥äº†è¿™æ®µä»£ç ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p><p>2)æ£€æŸ¥è¿™ä¸ª <code>handler</code> å®ä¾‹æ˜¯å¦æ˜¯å…±äº«çš„ï¼Œå¦‚æœä¸æ˜¯ï¼Œå¹¶ä¸”å·²ç»è¢«åˆ«çš„ <code>pipeline</code> ä½¿ç”¨äº†ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</p><p>3)è°ƒç”¨ <code>new Context(group, filterName(name, handler), handler)</code> æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ª <code>Context</code>ã€‚ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºæ¥äº†ï¼Œæ¯æ¬¡æ·»åŠ ä¸€ä¸ª <code>handler</code> éƒ½ä¼šåˆ›å»ºä¸€ä¸ªå…³è” <code>Context</code>ã€‚</p><p>4)è°ƒç”¨ <code>addLast</code> æ–¹æ³•ï¼Œå°† <code>Context</code> è¿½åŠ åˆ°é“¾è¡¨ä¸­ã€‚</p><p>5)å¦‚æœè¿™ä¸ªé€šé“è¿˜æ²¡æœ‰æ³¨å†Œåˆ° <code>selecor</code> ä¸Šï¼Œå°±å°†è¿™ä¸ª <code>Context</code> æ·»åŠ åˆ°è¿™ä¸ª <code>pipeline</code> çš„å¾…åŠä»»åŠ¡ä¸­ã€‚å½“æ³¨å†Œå¥½äº†ä»¥åï¼Œå°±ä¼šè°ƒç”¨ <code>callHandlerAdded0</code> æ–¹æ³•ï¼ˆé»˜è®¤æ˜¯ä»€ä¹ˆéƒ½ä¸åšï¼Œç”¨æˆ·å¯ä»¥å®ç°è¿™ä¸ªæ–¹æ³•ï¼‰ã€‚</p><p>6)åˆ°è¿™é‡Œï¼Œé’ˆå¯¹ä¸‰å¯¹è±¡åˆ›å»ºè¿‡ç¨‹ï¼Œäº†è§£çš„å·®ä¸å¤šäº†ï¼Œå’Œæœ€åˆè¯´çš„ä¸€æ ·ï¼Œæ¯å½“åˆ›å»º <code>ChannelSocket</code> çš„æ—¶å€™éƒ½ä¼šåˆ›å»ºä¸€ä¸ªç»‘å®šçš„ <code>pipeline</code>ï¼Œä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œåˆ›å»º <code>pipeline</code> çš„æ—¶å€™ä¹Ÿä¼šåˆ›å»º <code>tail</code> èŠ‚ç‚¹å’Œ <code>head</code> èŠ‚ç‚¹ï¼Œå½¢æˆæœ€åˆçš„é“¾è¡¨ã€‚<code>tail</code> æ˜¯å…¥ç«™ <code>inbound</code> ç±»å‹çš„ <code>handler</code>ï¼Œ<code>head</code> æ—¢æ˜¯ <code>inbound</code> ä¹Ÿæ˜¯ <code>outbound</code> ç±»å‹çš„ <code>handler</code>ã€‚åœ¨è°ƒç”¨ <code>pipeline</code> çš„ <code>addLast</code> æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæ ¹æ®ç»™å®šçš„ <code>handler</code> åˆ›å»ºä¸€ä¸ª <code>Context</code>ï¼Œç„¶åï¼Œå°†è¿™ä¸ª <code>Context</code> æ’å…¥åˆ°é“¾è¡¨çš„å°¾ç«¯ï¼ˆ<code>tail</code> å‰é¢ï¼‰ã€‚åˆ°æ­¤å°± <code>OK</code> äº†ã€‚</p><h3 id="_10-4-4-pipeline-handler-handlercontext-åˆ›å»ºè¿‡ç¨‹æ¢³ç†" tabindex="-1"><a class="header-anchor" href="#_10-4-4-pipeline-handler-handlercontext-åˆ›å»ºè¿‡ç¨‹æ¢³ç†" aria-hidden="true">#</a> 10.4.4 Pipeline Handler HandlerContext åˆ›å»ºè¿‡ç¨‹æ¢³ç†</h3><ol><li>æ¯å½“åˆ›å»º <code>ChannelSocket</code> çš„æ—¶å€™éƒ½ä¼šåˆ›å»ºä¸€ä¸ªç»‘å®šçš„ <code>pipeline</code>ï¼Œä¸€å¯¹ä¸€çš„å…³ç³»ï¼Œåˆ›å»º <code>pipeline</code> çš„æ—¶å€™ä¹Ÿä¼šåˆ›å»º <code>tail</code> èŠ‚ç‚¹å’Œ <code>head</code> èŠ‚ç‚¹ï¼Œå½¢æˆæœ€åˆçš„é“¾è¡¨ã€‚</li><li>åœ¨è°ƒç”¨ <code>pipeline</code> çš„ <code>addLast</code> æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæ ¹æ®ç»™å®šçš„ <code>handler</code> åˆ›å»ºä¸€ä¸ª <code>Context</code>ï¼Œç„¶åï¼Œå°†è¿™ä¸ª <code>Context</code> æ’å…¥åˆ°é“¾è¡¨çš„å°¾ç«¯ï¼ˆ<code>tail</code> å‰é¢ï¼‰ã€‚</li><li><code>Context</code> åŒ…è£… <code>handler</code>ï¼Œå¤šä¸ª <code>Context</code> åœ¨ <code>pipeline</code> ä¸­å½¢æˆäº†åŒå‘é“¾è¡¨</li><li>å…¥ç«™æ–¹å‘å« <code>inbound</code>ï¼Œç”± <code>head</code> èŠ‚ç‚¹å¼€å§‹ï¼Œå‡ºç«™æ–¹æ³•å« <code>outbound</code>ï¼Œç”± <code>tail</code> èŠ‚ç‚¹å¼€å§‹</li></ol><h2 id="_10-5-channelpipeline-è°ƒåº¦-handler-çš„æºç å‰–æ" tabindex="-1"><a class="header-anchor" href="#_10-5-channelpipeline-è°ƒåº¦-handler-çš„æºç å‰–æ" aria-hidden="true">#</a> 10.5 ChannelPipeline è°ƒåº¦ handler çš„æºç å‰–æ</h2><h3 id="_10-5-1-æºç å‰–æç›®çš„" tabindex="-1"><a class="header-anchor" href="#_10-5-1-æºç å‰–æç›®çš„" aria-hidden="true">#</a> 10.5.1 æºç å‰–æç›®çš„</h3><ol><li>å½“ä¸€ä¸ªè¯·æ±‚è¿›æ¥çš„æ—¶å€™ï¼Œ<code>ChannelPipeline</code> æ˜¯å¦‚ä½•è°ƒç”¨å†…éƒ¨çš„è¿™äº› <code>handler</code> çš„å‘¢ï¼Ÿæˆ‘ä»¬ä¸€èµ·æ¥åˆ†æä¸‹ã€‚</li><li>é¦–å…ˆï¼Œå½“ä¸€ä¸ªè¯·æ±‚è¿›æ¥çš„æ—¶å€™ï¼Œä¼šç¬¬ä¸€ä¸ªè°ƒç”¨ <code>pipeline</code> çš„ç›¸å…³æ–¹æ³•ï¼Œå¦‚æœæ˜¯å…¥ç«™äº‹ä»¶ï¼Œè¿™äº›æ–¹æ³•ç”± <code>fire</code> å¼€å¤´ï¼Œè¡¨ç¤ºå¼€å§‹ç®¡é“çš„æµåŠ¨ã€‚è®©åé¢çš„ <code>handler</code> ç»§ç»­å¤„ç†</li></ol><h3 id="_10-5-2-æºç å‰–æ" tabindex="-1"><a class="header-anchor" href="#_10-5-2-æºç å‰–æ" aria-hidden="true">#</a> 10.5.2 æºç å‰–æ</h3><p>è¯´æ˜</p><p>å½“æµè§ˆå™¨è¾“å…¥ <code>http://localhost:8007</code> ã€‚å¯ä»¥çœ‹åˆ°ä¼šæ‰§è¡Œ <code>handler</code> åœ¨ <code>Debug</code> æ—¶ï¼Œå¯ä»¥å°†æ–­ç‚¹ä¸‹åœ¨ <code>DefaultChannelPipeline</code> ç±»çš„</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AbstractChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">invokeChannelActive</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ–­ç‚¹</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æºç åˆ†æ</p><ol start="3"><li><code>DefaultChannelPipeline</code> æ˜¯å¦‚ä½•å®ç°è¿™äº› <code>fire</code> æ–¹æ³•çš„ 3.1 <code>DefaultChannelPipeline</code> æºç </li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultChannelPipeline</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelPipeline</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AbstractChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">invokeChannelActive</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipelinefireChannelInactive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AbstractChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">invokeChannelInactive</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">fireExceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AbstractChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">invokeExceptionCaught</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">fireUserEventTriggered</span><span class="token punctuation">(</span><span class="token class-name">Object</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AbstractChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">invokeUserEventTriggered</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">fireChannelRead</span><span class="token punctuation">(</span><span class="token class-name">Objectmsg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AbstractChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">invokeChannelRead</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">fireChannelReadComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AbstractChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">invokeChannelReadComplete</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">fireChannelWritabilityChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AbstractChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">invokeChannelWritabilityChanged</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™äº›æ–¹æ³•éƒ½æ˜¯ <code>inbound</code> çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å…¥ç«™äº‹ä»¶ï¼Œè°ƒç”¨é™æ€æ–¹æ³•ä¼ å…¥çš„ä¹Ÿæ˜¯ <code>inbound</code> çš„ç±»å‹ <code>head</code> <code>handler</code>ã€‚è¿™äº›é™æ€æ–¹æ³•åˆ™ä¼šè°ƒç”¨ <code>head</code> çš„ <code>ChannelInboundInvoker</code> æ¥å£çš„æ–¹æ³•ï¼Œå†ç„¶åè°ƒç”¨ <code>handler</code> çš„çœŸæ­£æ–¹æ³•</p><p>3.2å†çœ‹ä¸‹ <code>piepline</code> çš„ <code>outbound</code> çš„ <code>fire</code> æ–¹æ³•å®ç°æºç </p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultChannelPipeline</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelPipeline</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> tail<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">SocketAddress</span> remoteAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> tail<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>remoteAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">SocketAddress</span> remoteAddress<span class="token punctuation">,</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> tail<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>remoteAddress<span class="token punctuation">,</span> localAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> <span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> tail<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> tail<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> <span class="token function">deregister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> tail<span class="token punctuation">.</span><span class="token function">deregister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tail<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> tail<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">SocketAddress</span> remoteAddress<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> tail<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>remoteAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">SocketAddress</span> remoteAddress<span class="token punctuation">,</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> tail<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>remoteAddress<span class="token punctuation">,</span> localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> <span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> tail<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š</p><p>1)è¿™äº›éƒ½æ˜¯å‡ºç«™çš„å®ç°ï¼Œä½†æ˜¯è°ƒç”¨çš„æ˜¯ <code>outbound</code> ç±»å‹çš„ <code>tailhandler</code> æ¥è¿›è¡Œå¤„ç†ï¼Œå› ä¸ºè¿™äº›éƒ½æ˜¯ <code>outbound</code> äº‹ä»¶ã€‚</p><p>2)å‡ºç«™æ˜¯ <code>tail</code> å¼€å§‹ï¼Œå…¥ç«™ä» <code>head</code> å¼€å§‹ã€‚å› ä¸ºå‡ºç«™æ˜¯ä»å†…éƒ¨å‘å¤–é¢å†™ï¼Œä» <code>tail</code> å¼€å§‹ï¼Œèƒ½å¤Ÿè®©å‰é¢çš„ <code>handler</code> è¿›è¡Œå¤„ç†ï¼Œé˜²æ­¢ <code>handler</code> è¢«é—æ¼ï¼Œæ¯”å¦‚ç¼–ç ã€‚åä¹‹ï¼Œå…¥ç«™å½“ç„¶æ˜¯ä» <code>head</code> å¾€å†…éƒ¨è¾“å…¥ï¼Œè®©åé¢çš„ <code>handler</code> èƒ½å¤Ÿå¤„ç†è¿™äº›è¾“å…¥çš„æ•°æ®ã€‚æ¯”å¦‚è§£ç ã€‚å› æ­¤è™½ç„¶ <code>head</code> ä¹Ÿå®ç°äº† <code>outbound</code> æ¥å£ï¼Œä½†ä¸æ˜¯ä» head å¼€å§‹æ‰§è¡Œå‡ºç«™ä»»åŠ¡</p><p>4.å…³äºå¦‚ä½•è°ƒåº¦ï¼Œç”¨ä¸€å¼ å›¾æ¥è¡¨ç¤º:</p><p><img src="https://javablog-image.oss-cn-hangzhou.aliyuncs.com/blog/chapter10_13.png" alt="" loading="lazy"></p><p>è¯´æ˜ï¼š 1)<code>pipeline</code> é¦–å…ˆä¼šè°ƒç”¨ <code>Context</code> çš„é™æ€æ–¹æ³• <code>fireXXX</code>ï¼Œå¹¶ä¼ å…¥ <code>Context</code></p><p>2)ç„¶åï¼Œé™æ€æ–¹æ³•è°ƒç”¨ <code>Context</code> çš„ <code>invoker</code> æ–¹æ³•ï¼Œè€Œ <code>invoker</code> æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨è¯¥ <code>Context</code> æ‰€åŒ…å«çš„ <code>Handler</code> çš„çœŸæ­£çš„ <code>XXX</code> æ–¹æ³•ï¼Œè°ƒç”¨ç»“æŸåï¼Œå¦‚æœè¿˜éœ€è¦ç»§ç»­å‘åä¼ é€’ï¼Œå°±è°ƒç”¨ <code>Context</code> çš„ <code>fireXXX2</code> æ–¹æ³•ï¼Œå¾ªç¯å¾€å¤ã€‚</p><h3 id="_10-5-3-channelpipeline-è°ƒåº¦-handler-æ¢³ç†" tabindex="-1"><a class="header-anchor" href="#_10-5-3-channelpipeline-è°ƒåº¦-handler-æ¢³ç†" aria-hidden="true">#</a> 10.5.3 ChannelPipeline è°ƒåº¦ handler æ¢³ç†</h3><ol><li><code>Context</code> åŒ…è£… <code>handler</code>ï¼Œå¤šä¸ª <code>Context</code> åœ¨ <code>pipeline</code> ä¸­å½¢æˆäº†åŒå‘é“¾è¡¨ï¼Œå…¥ç«™æ–¹å‘å« <code>inbound</code>ï¼Œç”± <code>head</code> èŠ‚ç‚¹å¼€å§‹ï¼Œå‡ºç«™æ–¹æ³•å« <code>outbound</code>ï¼Œç”± <code>tail</code> èŠ‚ç‚¹å¼€å§‹ã€‚</li><li>è€ŒèŠ‚ç‚¹ä¸­é—´çš„ä¼ é€’é€šè¿‡ <code>Abstract ChannelHandlerContext</code> ç±»å†…éƒ¨çš„ <code>fire</code> ç³»åˆ—æ–¹æ³•ï¼Œæ‰¾åˆ°å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸æ–­çš„å¾ªç¯ä¼ æ’­ã€‚æ˜¯ä¸€ä¸ªè¿‡æ»¤å™¨å½¢å¼å®Œæˆå¯¹ <code>handler</code> çš„è°ƒåº¦</li></ol><h2 id="_10-6-netty-å¿ƒè·³-heartbeat-æœåŠ¡æºç å‰–æ" tabindex="-1"><a class="header-anchor" href="#_10-6-netty-å¿ƒè·³-heartbeat-æœåŠ¡æºç å‰–æ" aria-hidden="true">#</a> 10.6 Netty å¿ƒè·³(heartbeat)æœåŠ¡æºç å‰–æ</h2><h3 id="_10-6-1-æºç å‰–æç›®çš„" tabindex="-1"><a class="header-anchor" href="#_10-6-1-æºç å‰–æç›®çš„" aria-hidden="true">#</a> 10.6.1 æºç å‰–æç›®çš„</h3><p><code>Netty</code> ä½œä¸ºä¸€ä¸ªç½‘ç»œæ¡†æ¶ï¼Œæä¾›äº†è¯¸å¤šåŠŸèƒ½ï¼Œæ¯”å¦‚ç¼–ç è§£ç ç­‰ï¼Œ<code>Netty</code> è¿˜æä¾›äº†éå¸¸é‡è¦çš„ä¸€ä¸ªæœåŠ¡ -- å¿ƒè·³æœºåˆ¶ <code>heartbeat</code>ã€‚é€šè¿‡å¿ƒè·³æ£€æŸ¥å¯¹æ–¹æ˜¯å¦æœ‰æ•ˆï¼Œè¿™æ˜¯ <code>RPC</code> æ¡†æ¶ä¸­æ˜¯å¿…ä¸å¯å°‘çš„åŠŸèƒ½ã€‚ä¸‹é¢æˆ‘ä»¬åˆ†æä¸€ä¸‹ <code>Netty</code> å†…éƒ¨å¿ƒè·³æœåŠ¡æºç å®ç°ã€‚</p><h3 id="_10-6-2-æºç å‰–æ" tabindex="-1"><a class="header-anchor" href="#_10-6-2-æºç å‰–æ" aria-hidden="true">#</a> 10.6.2 æºç å‰–æ</h3><p>è¯´æ˜</p><p><code>Netty</code> æä¾›äº† <code>IdleStateHandler</code>ï¼Œ<code>ReadTimeoutHandler</code>ï¼Œ<code>WriteTimeoutHandler</code> ä¸‰ä¸ª <code>Handler</code> æ£€æµ‹è¿æ¥çš„æœ‰æ•ˆæ€§ï¼Œé‡ç‚¹åˆ†æ <code>IdleStateHandler</code>ã€‚</p><p>å¦‚å›¾</p><p><img src="https://javablog-image.oss-cn-hangzhou.aliyuncs.com/blog/chapter10_14.png" alt="" loading="lazy"></p><p>æºç å‰–æï¼š</p><p>5.<code>Netty</code> æä¾›çš„å¿ƒè·³ä»‹ç»</p><p>1)<code>Netty</code> æä¾›äº† <code>IdleStateHandler</code>ï¼Œ<code>ReadTimeoutHandler</code>ï¼Œ<code>WriteTimeoutHandler</code> ä¸‰ä¸ª <code>Handler</code> æ£€æµ‹è¿æ¥çš„æœ‰æ•ˆæ€§ã€‚</p><p>2)å¦‚å›¾</p><p><img src="https://javablog-image.oss-cn-hangzhou.aliyuncs.com/blog/chapter10_15.png" alt="" loading="lazy"></p><p>3)<code>ReadTimeout</code> äº‹ä»¶å’Œ <code>WriteTimeout</code> äº‹ä»¶éƒ½ä¼šè‡ªåŠ¨å…³é—­è¿æ¥ï¼Œè€Œä¸”ï¼Œå±äºå¼‚å¸¸å¤„ç†ï¼Œæ‰€ä»¥ï¼Œè¿™é‡Œåªæ˜¯ä»‹ç»ä»¥ä¸‹ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹ <code>IdleStateHandler</code>ã€‚</p><p>6.<code>IdleStateHandler</code> åˆ†æ</p><p>6.1 <code>4</code> ä¸ªå±æ€§</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> observeOutput<span class="token punctuation">;</span> <span class="token comment">//æ˜¯å¦è€ƒè™‘å‡ºç«™æ—¶è¾ƒæ…¢çš„æƒ…å†µã€‚é»˜è®¤å€¼æ˜¯ false</span>

<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> readerIdleTimeNanos<span class="token punctuation">;</span> <span class="token comment">//è¯»äº‹ä»¶ç©ºé—²æ—¶é—´ï¼Œ0 åˆ™ç¦ç”¨äº‹ä»¶</span>

<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> writerIdleTimeNanos<span class="token punctuation">;</span><span class="token comment">//å†™äº‹ä»¶ç©ºé—²æ—¶é—´ï¼Œ0 åˆ™ç¦ç”¨äº‹ä»¶</span>

<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> allIdleTimeNanos<span class="token punctuation">;</span><span class="token comment">//è¯»æˆ–å†™ç©ºé—²æ—¶é—´ï¼Œ0 åˆ™ç¦ç”¨äº‹ä»¶</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>6.2<code>handlerAdded</code> æ–¹æ³•</p><p>å½“è¯¥ <code>handler</code> è¢«æ·»åŠ åˆ° <code>pipeline</code> ä¸­æ—¶ï¼Œåˆ™è°ƒç”¨ <code>initialize</code> æ–¹æ³•</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//Avoid the case where destroy() is called before scheduling timeouts.</span>
    <span class="token comment">//See:https://github.com/netty/netty/issues/143</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        case1<span class="token operator">:</span>
        case2<span class="token operator">:</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    state<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">initOutputChanged</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    lastReadTime <span class="token operator">=</span> lastWriteTime <span class="token operator">=</span> <span class="token function">ticksInNanos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>readerIdleTimeNanos <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//è¿™é‡Œçš„ schedule æ–¹æ³•ä¼šè°ƒç”¨ eventLoop çš„ schedule æ–¹æ³•ï¼Œå°†å®šæ—¶ä»»åŠ¡æ·»åŠ è¿›é˜Ÿåˆ—ä¸­</span>
        readerIdleTimeout <span class="token operator">=</span> <span class="token function">schedule</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ReaderIdleTimeoutTask</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">,</span> readerIdleTimeNanos<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>writerIdleTimeNanos <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        writerIdleTimeout <span class="token operator">=</span> <span class="token function">schedule</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">WriterIdleTimeoutTask</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">,</span> writerIdleTimeNanos<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>allIdleTimeNanos <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        allIdleTimeout <span class="token operator">=</span> <span class="token function">schedule</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AllIdleTimeoutTask</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">,</span> allIdleTimeNanos<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åªè¦ç»™å®šçš„å‚æ•°å¤§äº <code>0</code>ï¼Œå°±åˆ›å»ºä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯ä¸ªäº‹ä»¶éƒ½åˆ›å»ºã€‚åŒæ—¶ï¼Œå°† <code>state</code> çŠ¶æ€è®¾ç½®ä¸º <code>1</code>ï¼Œé˜²æ­¢é‡å¤åˆå§‹åŒ–ã€‚è°ƒç”¨ <code>initOutputChanged</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–â€œç›‘æ§å‡ºç«™æ•°æ®å±æ€§â€ã€‚</p><p>6.3è¯¥ç±»å†…éƒ¨çš„ <code>3</code> ä¸ªå®šæ—¶ä»»åŠ¡ç±»</p><p><img src="https://javablog-image.oss-cn-hangzhou.aliyuncs.com/blog/chapter10_16.png" alt="" loading="lazy"></p><p>1)è¿™ <code>3</code> ä¸ªå®šæ—¶ä»»åŠ¡åˆ†åˆ«å¯¹åº”è¯»ï¼Œå†™ï¼Œè¯»æˆ–è€…å†™äº‹ä»¶ã€‚å…±æœ‰ä¸€ä¸ªçˆ¶ç±»ï¼ˆ<code>AbstractIdleTask</code>ï¼‰ã€‚è¿™ä¸ªçˆ¶ç±»æä¾›äº†ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">abstract</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AbstractIdleTask</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">;</span>
    
    <span class="token class-name">AbstractIdleTask</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx <span class="token operator">=</span> ctx<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">run</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼šå½“é€šé“å…³é—­äº†ï¼Œå°±ä¸æ‰§è¡Œä»»åŠ¡äº†ã€‚åä¹‹ï¼Œæ‰§è¡Œå­ç±»çš„ <code>run</code> æ–¹æ³•</p><p>7.è¯»äº‹ä»¶çš„ <code>run</code> æ–¹æ³•ï¼ˆå³ <code>ReaderIdleTimeoutTask</code> çš„ <code>run</code> æ–¹æ³•ï¼‰åˆ†æ</p><p>1)ä»£ç åŠå…¶è¯´æ˜</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> nextDelay <span class="token operator">=</span> readerIdleTimeNanos<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>reading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nextDelay <span class="token operator">-=</span> <span class="token function">ticksInNanos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> lastReadTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>nextDelay <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//Reader is idle-set a new timeout and notify the callback.</span>
        <span class="token comment">//ç”¨äºå–æ¶ˆä»»åŠ¡ promise</span>
        readerIdleTimeout <span class="token operator">=</span> <span class="token function">schedule</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> readerIdleTimeNanos<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> first <span class="token operator">=</span> firstReaderIdleEvent<span class="token punctuation">;</span>
        firstReaderIdleEvent <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//å†æ¬¡æäº¤ä»»åŠ¡</span>
            <span class="token class-name">IdleStateEvent</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IdleStateEvent</span><span class="token punctuation">(</span><span class="token class-name">IdleState</span><span class="token punctuation">.</span><span class="token constant">READER_IDLE</span><span class="token punctuation">,</span> first<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//è§¦å‘ç”¨æˆ· handler use</span>
            <span class="token function">channelIdle</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">fireExceptionCaught</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//Read occurred before the timeout - set a new timeout with shorter delay.</span>
        readerIdleTimeout <span class="token operator">=</span> <span class="token function">schedule</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> nextDelay<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š</p><p>1)å¾—åˆ°ç”¨æˆ·è®¾ç½®çš„è¶…æ—¶æ—¶é—´ã€‚</p><p>2)å¦‚æœè¯»å–æ“ä½œç»“æŸäº†ï¼ˆæ‰§è¡Œäº† <code>channelReadComplete</code> æ–¹æ³•è®¾ç½®ï¼‰ï¼Œå°±ç”¨å½“å‰æ—¶é—´å‡å»ç»™å®šæ—¶é—´å’Œæœ€åä¸€æ¬¡è¯»ï¼ˆæ‰§æ“ä½œçš„æ—¶é—´è¡Œäº† <code>channelReadComplete</code> æ–¹æ³•è®¾ç½®ï¼‰ï¼Œå¦‚æœå°äº <code>0</code>ï¼Œå°±è§¦å‘äº‹ä»¶ã€‚åä¹‹ï¼Œç»§ç»­æ”¾å…¥é˜Ÿåˆ—ã€‚é—´éš”æ—¶é—´æ˜¯æ–°çš„è®¡ç®—æ—¶é—´ã€‚</p><p>3)è§¦å‘çš„é€»è¾‘æ˜¯ï¼šé¦–å…ˆå°†ä»»åŠ¡å†æ¬¡æ”¾åˆ°é˜Ÿåˆ—ï¼Œæ—¶é—´æ˜¯åˆšå¼€å§‹è®¾ç½®çš„æ—¶é—´ï¼Œè¿”å›ä¸€ä¸ª <code>promise</code> å¯¹è±¡ï¼Œç”¨äºåšå–æ¶ˆæ“ä½œã€‚ç„¶åï¼Œè®¾ç½® <code>first</code> å±æ€§ä¸º<code>false</code>ï¼Œè¡¨ç¤ºï¼Œä¸‹ä¸€æ¬¡è¯»å–ä¸å†æ˜¯ç¬¬ä¸€æ¬¡äº†ï¼Œè¿™ä¸ªå±æ€§åœ¨ <code>channelRead</code> æ–¹æ³•ä¼šè¢«æ”¹æˆ <code>true</code>ã€‚</p><p>4)åˆ›å»ºä¸€ä¸ª <code>IdleStateEvent</code> ç±»å‹çš„å†™äº‹ä»¶å¯¹è±¡ï¼Œå°†æ­¤å¯¹è±¡ä¼ é€’ç»™ç”¨æˆ·çš„ <code>UserEventTriggered</code> æ–¹æ³•ã€‚å®Œæˆè§¦å‘äº‹ä»¶çš„æ“ä½œã€‚</p><p>5)æ€»çš„æ¥è¯´ï¼Œæ¯æ¬¡è¯»å–æ“ä½œéƒ½ä¼šè®°å½•ä¸€ä¸ªæ—¶é—´ï¼Œå®šæ—¶ä»»åŠ¡æ—¶é—´åˆ°äº†ï¼Œä¼šè®¡ç®—å½“å‰æ—¶é—´å’Œæœ€åä¸€æ¬¡è¯»çš„æ—¶é—´çš„é—´éš”ï¼Œå¦‚æœé—´éš”è¶…è¿‡äº†è®¾ç½®çš„æ—¶é—´ï¼Œå°±è§¦å‘ <code>UserEventTriggered</code> æ–¹æ³•ã€‚//å‰é¢ä»‹ç» <code>IdleStateHandler</code> è¯´è¿‡,å¯ä»¥çœ‹ä¸€ä¸‹</p><p>8.å†™äº‹ä»¶çš„ <code>run</code> æ–¹æ³•ï¼ˆå³ <code>WriterIdleTimeoutTask</code> çš„ <code>run</code> æ–¹æ³•ï¼‰åˆ†æ</p><p>1)<code>run</code> ä»£ç å’Œåˆ†æ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> lastWriteTime <span class="token operator">=</span> <span class="token class-name">IdleStateHandler</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastWriteTime<span class="token punctuation">;</span>
    <span class="token keyword">long</span> nextDelay <span class="token operator">=</span> writerIdleTimeNanos <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token function">ticksInNanos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>lastWriteTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextDelay <span class="token operator">&lt;=</span><span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//Writer is idle - set a new timeout and notify the callback.</span>
        writerIdleTimeout <span class="token operator">=</span> <span class="token function">schedule</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> writerIdleTimeNanos<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> first <span class="token operator">=</span> firstWriterIdleEvent<span class="token punctuation">;</span>
        firstWriterIdleEvent <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">hasOutputChanged</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> first<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token class-name">IdleStateEvent</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IdleStateEvent</span><span class="token punctuation">(</span><span class="token class-name">IdleState</span><span class="token punctuation">.</span><span class="token constant">WRITER_IDLE</span><span class="token punctuation">,</span> first<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">channelIdle</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">fireExceptionCaught</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//Write occurred before the timeout - set a new timeout with shorter delay.</span>
        writerIdleTimeout <span class="token operator">=</span> <span class="token function">schedule</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> nextDelay<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼šå†™ä»»åŠ¡çš„ <code>run</code> ä»£ç é€»è¾‘åŸºæœ¬å’Œè¯»ä»»åŠ¡çš„é€»è¾‘ä¸€æ ·ï¼Œå”¯ä¸€ä¸åŒçš„å°±æ˜¯æœ‰ä¸€ä¸ªé’ˆå¯¹å‡ºç«™è¾ƒæ…¢æ•°æ®çš„åˆ¤æ–­ <code>hasOutputChanged</code></p><p>9.æ‰€æœ‰äº‹ä»¶çš„ <code>run</code> æ–¹æ³•ï¼ˆå³ <code>AllIdleTimeoutTask</code> çš„ <code>run</code> æ–¹æ³•ï¼‰åˆ†æ</p><p>ä»£ç åˆ†æ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> nextDelay <span class="token operator">=</span> allIdleTimeNanos<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>reading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nextDelay <span class="token operator">-=</span> <span class="token function">ticksInNanos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>lastReadTime<span class="token punctuation">,</span> lastWriteTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>nextDelay <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//Both reader and writer are idle - set a new timeout and</span>
        <span class="token comment">//notify the callback.</span>
        allIdleTimeout <span class="token operator">=</span> <span class="token function">schedule</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> allIdleTimeNanos<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> first <span class="token operator">=</span> firstAllIdleEvent<span class="token punctuation">;</span>
        firstAllIdleEvent <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">hasOutputChanged</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> first<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token class-name">IdleStateEvent</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IdleStateEvent</span><span class="token punctuation">(</span><span class="token class-name">IdleState</span><span class="token punctuation">.</span><span class="token constant">ALL_IDLE</span><span class="token punctuation">,</span> first<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">channelIdle</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">fireExceptionCaught</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//Either read or write occurred before the timeout - set a new</span>
        <span class="token comment">//timeout with shorter delay.</span>
        allIdleTimeout <span class="token operator">=</span> <span class="token function">schedule</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> nextDelay<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š</p><p>1)è¡¨ç¤ºè¿™ä¸ªç›‘æ§ç€æ‰€æœ‰çš„äº‹ä»¶ã€‚å½“è¯»å†™äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œéƒ½ä¼šè®°å½•ã€‚ä»£ç é€»è¾‘å’Œå†™äº‹ä»¶çš„çš„åŸºæœ¬ä¸€è‡´ï¼š</p><p>2)éœ€è¦å¤§å®¶æ³¨æ„çš„åœ°æ–¹æ˜¯</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">long</span> nextDelay <span class="token operator">=</span> allIdleTimeNanos<span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>reading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//å½“å‰æ—¶é—´å‡å»æœ€åä¸€æ¬¡å†™æˆ–è¯»çš„æ—¶é—´ï¼Œè‹¥å¤§äº 0ï¼Œè¯´æ˜è¶…æ—¶äº†</span>
    nextDelay <span class="token operator">-=</span> <span class="token function">ticksInNanos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>lastReadTime<span class="token punctuation">,</span> lastWriteTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3)è¿™é‡Œçš„æ—¶é—´è®¡ç®—æ˜¯å–è¯»å†™äº‹ä»¶ä¸­çš„æœ€å¤§å€¼æ¥çš„ã€‚ç„¶ååƒå†™äº‹ä»¶ä¸€æ ·ï¼Œåˆ¤æ–­æ˜¯å¦å‘ç”Ÿäº†å†™çš„æ…¢çš„æƒ…å†µã€‚</p><p>10.å°ç»“ <code>Netty</code> çš„å¿ƒè·³æœºåˆ¶</p><p>1)<code>IdleStateHandler</code> å¯ä»¥å®ç°å¿ƒè·³åŠŸèƒ½ï¼Œå½“æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯æ²¡æœ‰ä»»ä½•è¯»å†™äº¤äº’æ—¶ï¼Œå¹¶è¶…è¿‡äº†ç»™å®šçš„æ—¶é—´ï¼Œåˆ™ä¼šè§¦å‘ç”¨æˆ· <code>handler</code> çš„ <code>userEventTriggered</code> æ–¹æ³•ã€‚ç”¨æˆ·å¯ä»¥åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å°è¯•å‘å¯¹æ–¹å‘é€ä¿¡æ¯ï¼Œå¦‚æœå‘é€å¤±è´¥ï¼Œåˆ™å…³é—­è¿æ¥ã€‚</p><p>2)<code>IdleStateHandler</code> çš„å®ç°åŸºäº <code>EventLoop</code> çš„å®šæ—¶ä»»åŠ¡ï¼Œæ¯æ¬¡è¯»å†™éƒ½ä¼šè®°å½•ä¸€ä¸ªå€¼ï¼Œåœ¨å®šæ—¶ä»»åŠ¡è¿è¡Œçš„æ—¶å€™ï¼Œé€šè¿‡è®¡ç®—å½“å‰æ—¶é—´å’Œè®¾ç½®æ—¶é—´å’Œä¸Šæ¬¡äº‹ä»¶å‘ç”Ÿæ—¶é—´çš„ç»“æœï¼Œæ¥åˆ¤æ–­æ˜¯å¦ç©ºé—²ã€‚</p><p>3)å†…éƒ¨æœ‰ <code>3</code> ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œåˆ†åˆ«å¯¹åº”è¯»äº‹ä»¶ï¼Œå†™äº‹ä»¶ï¼Œè¯»å†™äº‹ä»¶ã€‚é€šå¸¸ç”¨æˆ·ç›‘å¬è¯»å†™äº‹ä»¶å°±è¶³å¤Ÿäº†ã€‚</p><p>4)åŒæ—¶ï¼Œ<code>IdleStateHandler</code> å†…éƒ¨ä¹Ÿè€ƒè™‘äº†ä¸€äº›æç«¯æƒ…å†µï¼šå®¢æˆ·ç«¯æ¥æ”¶ç¼“æ…¢ï¼Œä¸€æ¬¡æ¥æ”¶æ•°æ®çš„é€Ÿåº¦è¶…è¿‡äº†è®¾ç½®çš„ç©ºé—²æ—¶é—´ã€‚<code>Netty</code> é€šè¿‡æ„é€ æ–¹æ³•ä¸­çš„ <code>observeOutput</code> å±æ€§æ¥å†³å®šæ˜¯å¦å¯¹å‡ºç«™ç¼“å†²åŒºçš„æƒ…å†µè¿›è¡Œåˆ¤æ–­ã€‚</p><p>5)å¦‚æœå‡ºç«™ç¼“æ…¢ï¼Œ<code>Netty</code> ä¸è®¤ä¸ºè¿™æ˜¯ç©ºé—²ï¼Œä¹Ÿå°±ä¸è§¦å‘ç©ºé—²äº‹ä»¶ã€‚ä½†ç¬¬ä¸€æ¬¡æ— è®ºå¦‚ä½•ä¹Ÿæ˜¯è¦è§¦å‘çš„ã€‚å› ä¸ºç¬¬ä¸€æ¬¡æ— æ³•åˆ¤æ–­æ˜¯å‡ºç«™ç¼“æ…¢è¿˜æ˜¯ç©ºé—²ã€‚å½“ç„¶ï¼Œå‡ºç«™ç¼“æ…¢çš„è¯ï¼Œå¯èƒ½é€ æˆ <code>OOM</code>ï¼Œ<code>OOM</code> æ¯”ç©ºé—²çš„é—®é¢˜æ›´å¤§ã€‚</p><p>6)æ‰€ä»¥ï¼Œå½“ä½ çš„åº”ç”¨å‡ºç°äº†å†…å­˜æº¢å‡ºï¼Œ<code>OOM</code> ä¹‹ç±»ï¼Œå¹¶ä¸”å†™ç©ºé—²æå°‘å‘ç”Ÿï¼ˆä½¿ç”¨äº† <code>observeOutput</code> ä¸º <code>true</code>ï¼‰ï¼Œé‚£ä¹ˆå°±éœ€è¦æ³¨æ„æ˜¯ä¸æ˜¯æ•°æ®å‡ºç«™é€Ÿåº¦è¿‡æ…¢ã€‚</p><p>7)è¿˜æœ‰ä¸€ä¸ªæ³¨æ„çš„åœ°æ–¹ï¼šå°±æ˜¯ <code>ReadTimeoutHandler</code>ï¼Œå®ƒç»§æ‰¿è‡ª <code>IdleStateHandler</code>ï¼Œå½“è§¦å‘è¯»ç©ºé—²äº‹ä»¶çš„æ—¶å€™ï¼Œå°±è§¦å‘ <code>ctx</code>. <code>fireExceptionCaught</code> æ–¹æ³•ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ª <code>ReadTimeoutException</code>ï¼Œç„¶åå…³é—­ <code>Socket</code>ã€‚</p><p>8)è€Œ <code>WriteTimeoutHandler</code> çš„å®ç°ä¸æ˜¯åŸºäº <code>IdleStateHandler</code> çš„ï¼Œä»–çš„åŸç†æ˜¯ï¼Œå½“è°ƒç”¨ <code>write</code> æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šåˆ›å»ºä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œä»»åŠ¡å†…å®¹æ˜¯æ ¹æ®ä¼ å…¥çš„ <code>promise</code> çš„å®Œæˆæƒ…å†µæ¥åˆ¤æ–­æ˜¯å¦è¶…å‡ºäº†å†™çš„æ—¶é—´ã€‚å½“å®šæ—¶ä»»åŠ¡æ ¹æ®æŒ‡å®šæ—¶é—´å¼€å§‹è¿è¡Œï¼Œå‘ç° <code>promise</code> çš„ <code>isDone</code> æ–¹æ³•è¿”å› <code>false</code>ï¼Œè¡¨æ˜è¿˜æ²¡æœ‰å†™å®Œï¼Œè¯´æ˜è¶…æ—¶äº†ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚å½“ <code>write</code> æ–¹æ³•å®Œæˆåï¼Œä¼šæ‰“æ–­å®šæ—¶ä»»åŠ¡ã€‚</p><h2 id="_10-7-netty-æ ¸å¿ƒç»„ä»¶-eventloop-æºç å‰–æ" tabindex="-1"><a class="header-anchor" href="#_10-7-netty-æ ¸å¿ƒç»„ä»¶-eventloop-æºç å‰–æ" aria-hidden="true">#</a> 10.7 Netty æ ¸å¿ƒç»„ä»¶ EventLoop æºç å‰–æ</h2><h3 id="_10-7-1-æºç å‰–æç›®çš„" tabindex="-1"><a class="header-anchor" href="#_10-7-1-æºç å‰–æç›®çš„" aria-hidden="true">#</a> 10.7.1 æºç å‰–æç›®çš„</h3><p><code>Echo</code> ç¬¬ä¸€è¡Œä»£ç å°±æ˜¯ï¼š<code>EventLoopGroup bossGroup = new NioEventLoopGroup(1)</code>; ä¸‹é¢åˆ†æå…¶æœ€æ ¸å¿ƒçš„ç»„ä»¶ <code>EventLoop</code>ã€‚</p><h3 id="_10-7-2-æºç å‰–æ" tabindex="-1"><a class="header-anchor" href="#_10-7-2-æºç å‰–æ" aria-hidden="true">#</a> 10.7.2 æºç å‰–æ</h3><p>æºç å‰–æ</p><p>1.<code>EventLoop</code>ä»‹ç» 1.1é¦–å…ˆçœ‹çœ‹ <code>NioEventLoop</code> çš„ç»§æ‰¿å›¾</p><p><img src="https://javablog-image.oss-cn-hangzhou.aliyuncs.com/blog/chapter10_17.png" alt="" loading="lazy"></p><p>è¯´æ˜é‡ç‚¹ï¼š 1)<code>ScheduledExecutorService</code> æ¥å£è¡¨ç¤ºæ˜¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡æ¥å£ï¼Œ<code>EventLoop</code> å¯ä»¥æ¥å—å®šæ—¶ä»»åŠ¡ã€‚</p><p>2)<code>EventLoop</code> æ¥å£ï¼š<code>Netty</code> æ¥å£æ–‡æ¡£è¯´æ˜è¯¥æ¥å£ä½œç”¨ï¼šä¸€æ—¦ <code>Channel</code> æ³¨å†Œäº†ï¼Œå°±å¤„ç†è¯¥ <code>Channel</code> å¯¹åº”çš„æ‰€æœ‰ <code>I/O</code> æ“ä½œã€‚</p><p>3)<code>SingleThreadEventExecutor</code> è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå•ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± </p><p>4)<code>EventLoop</code> æ˜¯ä¸€ä¸ªå•ä¾‹çš„çº¿ç¨‹æ± ï¼Œé‡Œé¢å«æœ‰ä¸€ä¸ªæ­»å¾ªç¯çš„çº¿ç¨‹ä¸æ–­çš„åšç€ <code>3</code> ä»¶äº‹æƒ…ï¼šç›‘å¬ç«¯å£ï¼Œå¤„ç†ç«¯å£äº‹ä»¶ï¼Œå¤„ç†é˜Ÿåˆ—äº‹ä»¶ã€‚æ¯ä¸ª <code>EventLoop</code> éƒ½å¯ä»¥ç»‘å®šå¤šä¸ª <code>Channel</code>ï¼Œè€Œæ¯ä¸ª <code>Channel</code> å§‹ç»ˆåªèƒ½ç”±ä¸€ä¸ª <code>EventLoop</code> æ¥å¤„ç†</p><ol start="2"><li><code>NioEventLoop</code> çš„ä½¿ç”¨ - <code>execute</code> æ–¹æ³•</li></ol><p>2.1 <code>execute</code> æºç å‰–æ</p><p><img src="https://javablog-image.oss-cn-hangzhou.aliyuncs.com/blog/chapter10_18.png" alt="" loading="lazy"></p><p>åœ¨ <code>EventLoop</code> çš„ä½¿ç”¨ï¼Œä¸€èˆ¬å°±æ˜¯ <code>eventloop.execute(task);</code> çœ‹ä¸‹ <code>execute</code> æ–¹æ³•çš„å®ç°(åœ¨ <code>SingleThreadEventExecutor</code> ç±»ä¸­)</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>task <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">&quot;task&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">boolean</span> inEventLoop <span class="token operator">=</span> <span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>inEventLoop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">addTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">startThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">removeTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>addTaskWakesUp<span class="token operator">&amp;&amp;</span><span class="token function">wakesUpForTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">wakeup</span><span class="token punctuation">(</span>inEventLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜: 1)é¦–å…ˆåˆ¤æ–­è¯¥ <code>EventLoop</code> çš„çº¿ç¨‹æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯ï¼Œç›´æ¥æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­å»ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™å°è¯•å¯åŠ¨çº¿ç¨‹ï¼ˆä½†ç”±äºçº¿ç¨‹æ˜¯å•ä¸ªçš„ï¼Œå› æ­¤åªèƒ½å¯åŠ¨ä¸€æ¬¡ï¼‰ï¼Œéšåå†å°†ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­å»ã€‚</p><p>2)å¦‚æœçº¿ç¨‹å·²ç»åœæ­¢ï¼Œå¹¶ä¸”åˆ é™¤ä»»åŠ¡å¤±è´¥ï¼Œåˆ™æ‰§è¡Œæ‹’ç»ç­–ç•¥ï¼Œé»˜è®¤æ˜¯æŠ›å‡ºå¼‚å¸¸ã€‚</p><p>3)å¦‚æœ <code>addTaskWakesUp</code> æ˜¯ <code>false</code>ï¼Œå¹¶ä¸”ä»»åŠ¡ä¸æ˜¯ <code>NonWakeupRunnable</code> ç±»å‹çš„ï¼Œå°±å°è¯•å”¤é†’ <code>selector</code>ã€‚è¿™ä¸ªæ—¶å€™ï¼Œé˜»å¡åœ¨ <code>selecor</code>çš„çº¿ç¨‹å°±ä¼šç«‹å³è¿”å›</p><p>4)å¯ä»¥ä¸‹æ–­ç‚¹æ¥è¿½è¸ª</p><p>2.2æˆ‘ä»¬ <code>debugaddTask</code> å’Œ <code>offerTask</code> æ–¹æ³•æºç </p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">addTask</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>task <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">&quot;task&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">offerTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">offerTask</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> taskQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3.<code>NioEventLoop</code> çš„çˆ¶ç±» <code>SingleThreadEventExecutor</code> çš„ <code>startThread</code> æ–¹æ³• 3.1å½“æ‰§è¡Œ <code>execute</code> æ–¹æ³•çš„æ—¶å€™ï¼Œå¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯ <code>EventLoop</code> æ‰€å±çº¿ç¨‹ï¼Œåˆ™å°è¯•å¯åŠ¨çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯ <code>startThread</code> æ–¹æ³•ï¼Œdubug ä»£ç å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token constant">ST_NOT_STARTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">STATE_UPDATER</span><span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">ST_NOT_STARTED</span><span class="token punctuation">,</span> <span class="token constant">ST_STARTED</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span><span class="token punctuation">{</span>
                <span class="token function">doStartThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token constant">STATE_UPDATER</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">ST_NOT_STARTED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token function">throwException</span><span class="token punctuation">(</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜:è¯¥æ–¹æ³•é¦–å…ˆåˆ¤æ–­æ˜¯å¦å¯åŠ¨è¿‡äº†ï¼Œä¿è¯ <code>EventLoop</code> åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œå¦‚æœæ²¡æœ‰å¯åŠ¨è¿‡ï¼Œåˆ™å°è¯•ä½¿ç”¨ <code>Cas</code> å°† <code>state</code> çŠ¶æ€æ”¹ä¸º <code>ST_STARTED</code>ï¼Œä¹Ÿå°±æ˜¯å·²å¯åŠ¨ã€‚ç„¶åè°ƒç”¨ <code>doStartThread</code> æ–¹æ³•ã€‚å¦‚æœå¤±è´¥ï¼Œåˆ™è¿›è¡Œå›æ»š</p><p>çœ‹ä¸‹ <code>doStartThread</code> æ–¹æ³•</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doStartThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token function">updateLastExecutionTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span><span class="token punctuation">{</span>
                <span class="token class-name">SingleThreadEventExecutor</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                success<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    intoldState <span class="token operator">=</span> state<span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>oldState <span class="token operator">&gt;=</span> <span class="token constant">ST_SHUTTING_DOWN</span> <span class="token operator">||</span> <span class="token constant">STATE_UPDATER</span><span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token class-name">SingleThreadEventExecutor</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> oldState<span class="token punctuation">,</span> <span class="token constant">ST_SHUTTING_DOWN</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">confirmShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        <span class="token constant">STATE_UPDATER</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">SingleThreadEventExecutor</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token constant">ST_TERMINATED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        threadLock<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        terminationFuture<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š 1)é¦–å…ˆè°ƒç”¨ <code>executor</code> çš„ <code>execute</code> æ–¹æ³•ï¼Œè¿™ä¸ª <code>executor</code> å°±æ˜¯åœ¨åˆ›å»º <code>EventLoopGroup</code> çš„æ—¶å€™åˆ›å»ºçš„ <code>ThreadPerTaskExecutor</code> ç±»ã€‚è¯¥ <code>execute</code> æ–¹æ³•ä¼šå°† <code>Runnable</code> åŒ…è£…æˆ <code>Netty</code> çš„ <code>FastThreadLocalThread</code>ã€‚</p><p>2)ä»»åŠ¡ä¸­ï¼Œé¦–å…ˆåˆ¤æ–­çº¿ç¨‹ä¸­æ–­çŠ¶æ€ï¼Œç„¶åè®¾ç½®æœ€åä¸€æ¬¡çš„æ‰§è¡Œæ—¶é—´ã€‚</p><p>3)æ‰§è¡Œå½“å‰ <code>NioEventLoop</code> çš„ <code>run</code> æ–¹æ³•ï¼Œæ³¨æ„ï¼šè¿™ä¸ªæ–¹æ³•æ˜¯ä¸ªæ­»å¾ªç¯ï¼Œæ˜¯æ•´ä¸ª <code>EventLoop</code> çš„æ ¸å¿ƒ</p><p>4)åœ¨ <code>finally</code> å—ä¸­ï¼Œä½¿ç”¨ <code>CAS</code> ä¸æ–­ä¿®æ”¹ <code>state</code> çŠ¶æ€ï¼Œæ”¹æˆ <code>ST_SHUTTING_DOWN</code>ã€‚ä¹Ÿå°±æ˜¯å½“çº¿ç¨‹ <code>Loop</code> ç»“æŸçš„æ—¶å€™ã€‚å…³é—­çº¿ç¨‹ã€‚æœ€åè¿˜è¦æ­»å¾ªç¯ç¡®è®¤æ˜¯å¦å…³é—­ï¼Œå¦åˆ™ä¸ä¼š <code>break</code>ã€‚ç„¶åï¼Œæ‰§è¡Œ <code>cleanup</code> æ“ä½œï¼Œæ›´æ–°çŠ¶æ€ä¸º</p><p>5)<code>ST_TERMINATED</code>ï¼Œå¹¶é‡Šæ”¾å½“å‰çº¿ç¨‹é”ã€‚å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸æ˜¯ç©ºï¼Œåˆ™æ‰“å°é˜Ÿåˆ—ä¸­è¿˜æœ‰å¤šå°‘ä¸ªæœªå®Œæˆçš„ä»»åŠ¡ã€‚å¹¶å›è°ƒ <code>terminationFuture</code> æ–¹æ³•ã€‚</p><p>6)å…¶å®æœ€æ ¸å¿ƒçš„å°±æ˜¯ <code>EventLoop</code> è‡ªèº«çš„ <code>run</code> æ–¹æ³•ã€‚å†ç»§ç»­æ·±å…¥ <code>run</code> æ–¹æ³•</p><p>4.<code>EventLoop</code> ä¸­çš„ <code>Loop</code> æ˜¯é  <code>run</code> å®ç°çš„ï¼Œæˆ‘ä»¬åˆ†æä¸‹ <code>run</code> æ–¹æ³•(è¯¥æ–¹æ³•åœ¨ <code>NioEventLoop</code>)</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span><span class="token punctuation">(</span>selectStrategy<span class="token punctuation">.</span><span class="token function">calculateStrategy</span><span class="token punctuation">(</span>selectNowSupplier<span class="token punctuation">,</span><span class="token function">hasTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token class-name">SelectStrategy</span><span class="token punctuation">.</span><span class="token constant">CONTINUE</span><span class="token operator">:</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token class-name">SelectStrategy</span><span class="token punctuation">.</span><span class="token constant">SELECT</span><span class="token operator">:</span>
                    <span class="token function">select</span><span class="token punctuation">(</span>wakenUp<span class="token punctuation">.</span><span class="token function">getAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>wakenUp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        selector<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>    
                <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token punctuation">}</span>
            
            cancelledKeys <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            needsToSelectAgain <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> ioRatio <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ioRatio<span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ioRatio <span class="token operator">==</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token function">processSelectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token comment">//Ensure we always run tasks.</span>
                    <span class="token function">runAllTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">long</span> ioStartTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token function">processSelectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token comment">//Ensure we always runtasks.</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> ioTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> ioStartTime<span class="token punctuation">;</span>
                    <span class="token function">runAllTasks</span><span class="token punctuation">(</span>ioTime <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">-</span> ioRatio<span class="token punctuation">)</span> <span class="token operator">/</span> ioRatio<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">handleLoopException</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//Always handle shutdown even if the loop processing threw an exception.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isShuttingDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">closeAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">confirmShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">handleLoopException</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜: 1)ä»ä¸Šé¢çš„æ­¥éª¤å¯ä»¥çœ‹å‡ºï¼Œæ•´ä¸ª <code>run</code> æ–¹æ³•åšäº† <code>3</code> ä»¶äº‹æƒ…ï¼š <code>select</code> è·å–æ„Ÿå…´è¶£çš„äº‹ä»¶ã€‚ <code>processSelectedKeys</code> å¤„ç†äº‹ä»¶ã€‚ <code>runAllTasks</code> æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</p><p>2)ä¸Šé¢çš„ä¸‰ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å°±è¿½ä¸€ä¸‹ <code>select</code> æ–¹æ³•(ä½“ç°éé˜»å¡)æ ¸å¿ƒ <code>select</code> æ–¹æ³•è§£æ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> oldWakenUp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Selector</span> selector <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> selectCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> currentTimeNanos <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> selectDeadLineNanos <span class="token operator">=</span> currentTimeNanos <span class="token operator">+</span> <span class="token function">delayNanos</span><span class="token punctuation">(</span>currentTimeNanos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> timeoutMillis <span class="token operator">=</span> <span class="token punctuation">(</span>selectDeadLineNanos <span class="token operator">-</span> currentTimeNanos <span class="token operator">+</span> <span class="token number">500000L</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000000L</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>timeoutMillis <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>selectCnt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    selector<span class="token punctuation">.</span><span class="token function">selectNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    selectCnt<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//If a task was submitted when wakenUp value was true, the task didn&#39;t get a chance to call</span>
            <span class="token comment">//Selector#wakeup. So we need to check task queue again before executing select operation.</span>
            <span class="token comment">//If wedon&#39;t, the task might be pended until select operation was timedout.</span>
            <span class="token comment">//It might be pended until idle timeout if IdleStateHandler existed inpipeline.</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">hasTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> wakenUp<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                selector<span class="token punctuation">.</span><span class="token function">selectNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                selectCnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token keyword">int</span> selectedKeys <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¦åˆ™é˜»å¡ç»™å®šæ—¶é—´ï¼Œé»˜è®¤ä¸€ç§’</span>
            selectCnt<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token comment">//å¦‚æœ 1 ç§’åè¿”å›ï¼Œæœ‰è¿”å›å€¼||selectè¢«ç”¨æˆ·å”¤é†’||ä»»åŠ¡é˜Ÿåˆ—æœ‰ä»»åŠ¡||æœ‰å®šæ—¶ä»»åŠ¡å³å°†è¢«æ‰§è¡Œï¼›åˆ™è·³å‡ºå¾ªç¯</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>selectedKeys <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> oldWakenUp <span class="token operator">||</span> wakenUp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">hasTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">hasScheduledTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//-Selected something,</span>
                <span class="token comment">//-waken up by user,or</span>
                <span class="token comment">//-the task queue has apending task.</span>
                <span class="token comment">//-a scheduled task is ready for processing</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//Thread was interrupted so reset selected keys and break so we not run into a busy loop.</span>
                <span class="token comment">//As this is most likely a bug in the handler of the user or it&#39;s client library we will</span>
                <span class="token comment">//also log it.</span>
                <span class="token comment">//</span>
                <span class="token comment">//See https://github.com/netty/netty/issues/2426</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Selector.select() returned prematurely because &quot;</span> <span class="token operator">+</span> <span class="token string">&quot; Thread.currentThread().interrupt() was called. Use &quot;</span> <span class="token operator">+</span> <span class="token string">&quot; NioEventLoop.shutdownGracefully() to shutdowntheNioEventLoop.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                selectCnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">long</span> time <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>time <span class="token operator">-</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>timeoutMillis<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> currentTimeNanos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//timeoutMillis elapsed without any thing selected.</span>
                selectCnt <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">SELECTOR_AUTO_REBUILD_THRESHOLD</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> selectCnt <span class="token operator">&gt;=</span> <span class="token constant">SELECTOR_AUTO_REBUILD_THRESHOLD</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//The selector returned prematurely many times in a row.</span>
                <span class="token comment">//Rebuild the selector to work around the problem.</span>
                logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Selector.select() returned prematurely {} times in a row; rebuilding Selector {}.&quot;</span><span class="token punctuation">,</span> selectCnt<span class="token punctuation">,</span> selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">rebuildSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                selector <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">;</span>
                <span class="token comment">//Select again to populate selectedKeys.</span>
                selector<span class="token punctuation">.</span><span class="token function">selectNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                selectCnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            currentTimeNanos <span class="token operator">=</span> time<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span><span class="token punctuation">(</span>selectCnt <span class="token operator">&gt;</span> <span class="token constant">MIN_PREMATURE_SELECTOR_RETURNS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Selector.select()returned prematurely {} times in a row for Selector{}.&quot;</span><span class="token punctuation">,</span> selectCnt <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;raisedbyaSelector {} - JDKbug?&quot;</span><span class="token punctuation">,</span> selector<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//Harmless exception - log anyway</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼šè°ƒç”¨ <code>selector</code> çš„ <code>select</code> æ–¹æ³•ï¼Œé»˜è®¤é˜»å¡ä¸€ç§’é’Ÿï¼Œå¦‚æœæœ‰å®šæ—¶ä»»åŠ¡ï¼Œåˆ™åœ¨å®šæ—¶ä»»åŠ¡å‰©ä½™æ—¶é—´çš„åŸºç¡€ä¸Šåœ¨åŠ ä¸Š <code>0.5</code> ç§’è¿›è¡Œé˜»å¡ã€‚å½“æ‰§è¡Œ <code>execute</code> æ–¹æ³•çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯æ·»åŠ ä»»åŠ¡çš„æ—¶å€™ï¼Œå”¤é†’ <code>selector</code>ï¼Œé˜²æ­¢ <code>selector</code> é˜»å¡æ—¶é—´è¿‡é•¿</p><p>5.<code>EventLoop</code> ä½œä¸º <code>Netty</code> çš„æ ¸å¿ƒçš„è¿è¡Œæœºåˆ¶å°ç»“</p><p>1)æ¯æ¬¡æ‰§è¡Œ <code>execute</code> æ–¹æ³•éƒ½æ˜¯å‘é˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡ã€‚å½“ç¬¬ä¸€æ¬¡æ·»åŠ æ—¶å°±å¯åŠ¨çº¿ç¨‹ï¼Œæ‰§è¡Œ <code>run</code> æ–¹æ³•ï¼Œè€Œ <code>run</code> æ–¹æ³•æ˜¯æ•´ä¸ª <code>EventLoop</code> çš„æ ¸å¿ƒï¼Œå°±åƒ <code>EventLoop</code> çš„åå­—ä¸€æ ·ï¼Œ<code>LoopLoop</code>ï¼Œä¸åœçš„ <code>Loop</code>ï¼Œ<code>Loop</code> åšä»€ä¹ˆå‘¢ï¼Ÿåš <code>3</code> ä»¶äº‹æƒ…ã€‚</p><p>è°ƒç”¨ <code>selector</code> çš„ <code>select</code> æ–¹æ³•ï¼Œé»˜è®¤é˜»å¡ä¸€ç§’é’Ÿï¼Œå¦‚æœæœ‰å®šæ—¶ä»»åŠ¡ï¼Œåˆ™åœ¨å®šæ—¶ä»»åŠ¡å‰©ä½™æ—¶é—´çš„åŸºç¡€ä¸Šåœ¨åŠ ä¸Š <code>0.5</code> ç§’è¿›è¡Œé˜»å¡ã€‚å½“æ‰§è¡Œ <code>execute</code> æ–¹æ³•çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯æ·»åŠ ä»»åŠ¡çš„æ—¶å€™ï¼Œå”¤é†’ <code>selecor</code>ï¼Œé˜²æ­¢ <code>selector</code> é˜»å¡æ—¶é—´è¿‡é•¿ã€‚</p><p>å½“ <code>selector</code> è¿”å›çš„æ—¶å€™ï¼Œå›è°ƒç”¨ <code>processSelectedKeys</code> æ–¹æ³•å¯¹ <code>selectKey</code> è¿›è¡Œå¤„ç†ã€‚</p><p>å½“ <code>processSelectedKeys</code> æ–¹æ³•æ‰§è¡Œç»“æŸåï¼Œåˆ™æŒ‰ç…§ <code>ioRatio</code> çš„æ¯”ä¾‹æ‰§è¡Œ <code>runAllTasks</code> æ–¹æ³•ï¼Œé»˜è®¤æ˜¯ <code>IO</code> ä»»åŠ¡æ—¶é—´å’Œé <code>IO</code> ä»»åŠ¡æ—¶é—´æ˜¯ç›¸åŒçš„ï¼Œä½ ä¹Ÿå¯ä»¥æ ¹æ®ä½ çš„åº”ç”¨ç‰¹ç‚¹è¿›è¡Œè°ƒä¼˜ã€‚æ¯”å¦‚é <code>IO</code> ä»»åŠ¡æ¯”è¾ƒå¤šï¼Œé‚£ä¹ˆä½ å°±å°†</p><p><code>ioRatio</code> è°ƒå°ä¸€ç‚¹ï¼Œè¿™æ ·é <code>IO</code> ä»»åŠ¡å°±èƒ½æ‰§è¡Œçš„é•¿ä¸€ç‚¹ã€‚é˜²æ­¢é˜Ÿåˆ—ç§¯æ”’è¿‡å¤šçš„ä»»åŠ¡ã€‚</p><h2 id="_10-8-handler-ä¸­åŠ å…¥çº¿ç¨‹æ± å’Œ-context-ä¸­æ·»åŠ çº¿ç¨‹æ± çš„æºç å‰–æ" tabindex="-1"><a class="header-anchor" href="#_10-8-handler-ä¸­åŠ å…¥çº¿ç¨‹æ± å’Œ-context-ä¸­æ·»åŠ çº¿ç¨‹æ± çš„æºç å‰–æ" aria-hidden="true">#</a> 10.8 handler ä¸­åŠ å…¥çº¿ç¨‹æ± å’Œ Context ä¸­æ·»åŠ çº¿ç¨‹æ± çš„æºç å‰–æ</h2><h3 id="_10-8-1-æºç å‰–æç›®çš„" tabindex="-1"><a class="header-anchor" href="#_10-8-1-æºç å‰–æç›®çš„" aria-hidden="true">#</a> 10.8.1 æºç å‰–æç›®çš„</h3><ol><li>åœ¨ <code>Netty</code> ä¸­åšè€—æ—¶çš„ï¼Œä¸å¯é¢„æ–™çš„æ“ä½œï¼Œæ¯”å¦‚æ•°æ®åº“ï¼Œç½‘ç»œè¯·æ±‚ï¼Œä¼šä¸¥é‡å½±å“ <code>Netty</code> å¯¹ <code>Socket</code> çš„å¤„ç†é€Ÿåº¦ã€‚</li><li>è€Œè§£å†³æ–¹æ³•å°±æ˜¯å°†è€—æ—¶ä»»åŠ¡æ·»åŠ åˆ°å¼‚æ­¥çº¿ç¨‹æ± ä¸­ã€‚ä½†å°±æ·»åŠ çº¿ç¨‹æ± è¿™æ­¥æ“ä½œæ¥è®²ï¼Œå¯ä»¥æœ‰ <code>2</code> ç§æ–¹å¼ï¼Œè€Œä¸”è¿™ <code>2</code> ç§æ–¹å¼å®ç°çš„åŒºåˆ«ä¹Ÿè›®å¤§çš„ã€‚</li><li>å¤„ç†è€—æ—¶ä¸šåŠ¡çš„ç¬¬ä¸€ç§æ–¹å¼ -- <code>handler</code> ä¸­åŠ å…¥çº¿ç¨‹æ± </li><li>å¤„ç†è€—æ—¶ä¸šåŠ¡çš„ç¬¬äºŒç§æ–¹å¼ -- <code>Context</code> ä¸­æ·»åŠ çº¿ç¨‹æ± </li><li>æˆ‘ä»¬å°±æ¥åˆ†æä¸‹ä¸¤ç§æ–¹å¼</li></ol><h3 id="_10-8-2-æºç å‰–æ" tabindex="-1"><a class="header-anchor" href="#_10-8-2-æºç å‰–æ" aria-hidden="true">#</a> 10.8.2 æºç å‰–æ</h3><p>è¯´æ˜ æ¼”ç¤ºä¸¤ç§æ–¹å¼çš„å®ç°ï¼Œä»¥åŠä»æºç æ¥è¿½è¸ªä¸¤ç§æ–¹å¼æ‰§è¡Œæµç¨‹</p><ol start="11"><li>å¤„ç†è€—æ—¶ä¸šåŠ¡çš„ç¬¬ä¸€ç§æ–¹å¼ -- handlerç§åŠ å…¥çº¿ç¨‹æ±  11.1å¯¹å‰é¢çš„ <code>Netty</code> <code>demo</code>æºç è¿›è¡Œä¿®æ”¹ï¼Œåœ¨ <code>EchoServerHandler</code> çš„ <code>channelRead</code> æ–¹æ³•è¿›è¡Œå¼‚æ­¥</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@Sharable</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">EventExecutorGroup</span> group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultEventExecutorGroup</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnsupportedEncodingException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">Object</span> msgCop <span class="token operator">=</span> msg<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">ChannelHandlerContext</span> cxtCop <span class="token operator">=</span> ctx<span class="token punctuation">;</span>
        group<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token class-name">ByteBuf</span> buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">)</span>msgCop<span class="token punctuation">;</span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>buf<span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                buf<span class="token punctuation">.</span><span class="token function">readBytes</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>body <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> reqString <span class="token operator">=</span> <span class="token string">&quot;Helloiamserver~~~&quot;</span><span class="token punctuation">;</span>
                <span class="token class-name">ByteBuf</span> resp <span class="token operator">=</span> <span class="token class-name">Unpooled</span><span class="token punctuation">.</span><span class="token function">copiedBuffer</span><span class="token punctuation">(</span>reqString<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                cxtCop<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;goon..&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelReadComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Close the connection when an exception is raised.</span>
        cause<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š 1)åœ¨ <code>channelRead</code> æ–¹æ³•ï¼Œæ¨¡æ‹Ÿäº†ä¸€ä¸ªè€—æ—¶ <code>10</code> ç§’çš„æ“ä½œï¼Œè¿™é‡Œï¼Œæˆ‘ä»¬å°†è¿™ä¸ªä»»åŠ¡æäº¤åˆ°äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„ä¸šåŠ¡çº¿ç¨‹æ± ä¸­ï¼Œè¿™æ ·ï¼Œå°±ä¸ä¼šé˜»å¡ <code>Netty</code> çš„ <code>IO</code> çº¿ç¨‹ã€‚</p><p>11.2è¿™æ ·å¤„ç†ä¹‹åï¼Œæ•´ä¸ªç¨‹åºçš„é€»è¾‘å¦‚å›¾</p><p><img src="https://javablog-image.oss-cn-hangzhou.aliyuncs.com/blog/chapter10_19.png" alt="" loading="lazy"></p><p>è¯´æ˜ï¼š</p><p>1)è§£é‡Šä¸€ä¸‹ä¸Šå›¾ï¼Œå½“ <code>IO</code> çº¿ç¨‹è½®è¯¢åˆ°ä¸€ä¸ª <code>socket</code> äº‹ä»¶ï¼Œç„¶åï¼Œ<code>IO</code> çº¿ç¨‹å¼€å§‹å¤„ç†ï¼Œå½“èµ°åˆ°è€—æ—¶ <code>handler</code> çš„æ—¶å€™ï¼Œå°†è€—æ—¶ä»»åŠ¡äº¤ç»™ä¸šåŠ¡çº¿ç¨‹æ± ã€‚</p><p>2)å½“è€—æ—¶ä»»åŠ¡æ‰§è¡Œå®Œæ¯•å†æ‰§è¡Œ <code>pipeline write</code> æ–¹æ³•çš„æ—¶å€™ï¼Œ(ä»£ç ä¸­ä½¿ç”¨çš„æ˜¯ <code>context</code> çš„ <code>write</code> æ–¹æ³•ï¼Œä¸Šå›¾ç”»çš„æ˜¯æ‰§è¡Œ <code>pipeline</code> æ–¹æ³•ï¼Œæ˜¯ä¸€ä¸ªæ„æ€)ä¼šå°†ä»»åŠ¡è¿™ä¸ªä»»åŠ¡äº¤ç»™ <code>IO</code> çº¿ç¨‹</p><p>11.3 <code>write</code> æ–¹æ³•çš„æºç (åœ¨ <code>AbstractChannelHandlerContext</code> ç±»)</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token keyword">boolean</span> flush<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AbstractChannelHandlerContext</span> next <span class="token operator">=</span> <span class="token function">findContextOutbound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Object</span> m <span class="token operator">=</span> pipeline<span class="token punctuation">.</span><span class="token function">touch</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>flush<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            next<span class="token punctuation">.</span><span class="token function">invokeWriteAndFlush</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            next<span class="token punctuation">.</span><span class="token function">invokeWrite</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">AbstractWriteTask</span> task<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>flush<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            task <span class="token operator">=</span> <span class="token class-name">WriteAndFlushTask</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> m<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            task <span class="token operator">=</span> <span class="token class-name">WriteTask</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> m<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">safeExecute</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> task<span class="token punctuation">,</span> promise<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜:</p><p>1)å½“åˆ¤å®šä¸‹ä¸ª <code>outbound</code> çš„ <code>executor</code> çº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹çš„æ—¶å€™ï¼Œä¼šå°†å½“å‰çš„å·¥ä½œå°è£…æˆ <code>task</code>ï¼Œç„¶åæ”¾å…¥ <code>mpsc</code> é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾… <code>IO</code> ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</p><p>2)è¿™é‡Œå¯ä»¥ Debug æ¥éªŒè¯(æé†’ï¼šDebug æ—¶ï¼ŒæœåŠ¡å™¨ç«¯ Debug, å®¢æˆ·ç«¯ <code>Run</code> çš„æ–¹å¼)ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨äº† <code>group.submit(new Callable&lt;Object&gt; (){}</code> åœ¨ <code>handler</code> ä¸­åŠ å…¥çº¿ç¨‹æ± ï¼Œå°±ä¼šè¿›å…¥åˆ° <code>safeExecute(executor, task, promise, m);</code> å¦‚æœå»æ‰è¿™æ®µä»£ç ï¼Œè€Œä½¿ç”¨æ™®é€šæ–¹å¼æ¥æ‰§è¡Œè€—æ—¶çš„ä¸šåŠ¡ï¼Œé‚£ä¹ˆå°±ä¸ä¼šè¿›å…¥åˆ° <code>safeExecute(executor, task, promise, m);</code>ï¼ˆè¯´æ˜ï¼šæ™®é€šæ–¹å¼æ‰§è¡Œè€—æ—¶ä»£ç ï¼Œçœ‹æˆ‘å‡†å¤‡å¥½çš„æ¡ˆä¾‹å³å¯ï¼‰</p><p>12.å¤„ç†è€—æ—¶ä¸šåŠ¡çš„ç¬¬äºŒç§æ–¹å¼ -<code>Context</code> ä¸­æ·»åŠ çº¿ç¨‹æ±  1.1åœ¨æ·»åŠ  <code>pipeline</code> ä¸­çš„ <code>handler</code> æ—¶å€™ï¼Œæ·»åŠ ä¸€ä¸ªçº¿ç¨‹æ± </p><p>//å±æ€§</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">EventExecutorGroup</span> group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultEventExecutorGroup</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span> workerGroup<span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_BACKLOG</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token function">newLoggingHandler</span><span class="token punctuation">(</span><span class="token class-name">LogLevel</span><span class="token punctuation">.</span><span class="token constant">INFO</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     <span class="token annotation punctuation">@Override</span>
                     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                         <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                         <span class="token keyword">if</span><span class="token punctuation">(</span>sslCtx <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                             p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>sslCtx<span class="token punctuation">.</span><span class="token function">newHandler</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                         <span class="token punctuation">}</span>
                         <span class="token comment">//p.addLast(new LoggingHandler(LogLevel.INFO));</span>
                         <span class="token comment">//p.addLast(new EchoServerHandler());</span>
                         p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">EchoServerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š</p><p>1)<code>handler</code> ä¸­çš„ä»£ç å°±ä½¿ç”¨æ™®é€šçš„æ–¹å¼æ¥å¤„ç†è€—æ—¶ä¸šåŠ¡ã€‚</p><p>2)å½“æˆ‘ä»¬åœ¨è°ƒç”¨ <code>addLast</code> æ–¹æ³•æ·»åŠ çº¿ç¨‹æ± åï¼Œ<code>handler</code> å°†ä¼˜å…ˆä½¿ç”¨è¿™ä¸ªçº¿ç¨‹æ± ï¼Œå¦‚æœä¸æ·»åŠ ï¼Œå°†ä½¿ç”¨ <code>IO</code> çº¿ç¨‹</p><p>3)å½“èµ°åˆ° <code>AbstractChannelHandlerContext</code> çš„ <code>invokeChannelRead</code> æ–¹æ³•çš„æ—¶å€™ï¼Œ<code>executor.inEventLoop()</code> æ˜¯ä¸ä¼šé€šè¿‡çš„ï¼Œå› ä¸ºå½“å‰çº¿ç¨‹æ˜¯ <code>IO</code> çº¿ç¨‹ <code>Context</code>ï¼ˆä¹Ÿå°±æ˜¯ <code>Handler</code>ï¼‰çš„ <code>executor</code> æ˜¯ä¸šåŠ¡çº¿ç¨‹ï¼Œæ‰€ä»¥ä¼šå¼‚æ­¥æ‰§è¡Œï¼Œdebug ä¸‹æºç </p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">invokeChannelRead</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> next<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Object</span> m <span class="token operator">=</span> next<span class="token punctuation">.</span>pipeline<span class="token punctuation">.</span><span class="token function">touch</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token string">&quot;msg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        next<span class="token punctuation">.</span><span class="token function">invokeChannelRead</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//æ‰§è¡Œrun</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                next<span class="token punctuation">.</span><span class="token function">invokeChannelRead</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4)éªŒè¯æ—¶ï¼Œæˆ‘ä»¬å¦‚æœå»æ‰ <code>p.addLast(group,newEchoServerHandler());</code> æ”¹æˆ <code>p.addLastnewEchoServerHandler());</code> ä½ ä¼šå‘ç°ä»£ç ä¸ä¼šè¿›è¡Œå¼‚æ­¥æ‰§è¡Œã€‚</p><p>5)åé¢çš„æ•´ä¸ªæµç¨‹å°±å˜æˆå’Œç¬¬ä¸€ä¸ªæ–¹å¼ä¸€æ ·äº†</p><p>13.ä¸¤ç§æ–¹å¼çš„æ¯”è¾ƒ</p><p>1)ç¬¬ä¸€ç§æ–¹å¼åœ¨ <code>handler</code> ä¸­æ·»åŠ å¼‚æ­¥ï¼Œå¯èƒ½æ›´åŠ çš„è‡ªç”±ï¼Œæ¯”å¦‚å¦‚æœéœ€è¦è®¿é—®æ•°æ®åº“ï¼Œé‚£æˆ‘å°±å¼‚æ­¥ï¼Œå¦‚æœä¸éœ€è¦ï¼Œå°±ä¸å¼‚æ­¥ï¼Œå¼‚æ­¥ä¼šæ‹–é•¿æ¥å£å“åº”æ—¶é—´ã€‚å› ä¸ºéœ€è¦å°†ä»»åŠ¡æ”¾è¿› <code>mpscTask</code> ä¸­ã€‚å¦‚æœ <code>IO</code> æ—¶é—´å¾ˆçŸ­ï¼Œ<code>task</code> å¾ˆå¤šï¼Œå¯èƒ½ä¸€ä¸ªå¾ªç¯ä¸‹æ¥ï¼Œéƒ½æ²¡æ—¶é—´æ‰§è¡Œæ•´ä¸ª <code>task</code>ï¼Œå¯¼è‡´å“åº”æ—¶é—´è¾¾ä¸åˆ°æŒ‡æ ‡ã€‚</p><p>2)ç¬¬äºŒç§æ–¹å¼æ˜¯ <code>Netty</code> æ ‡å‡†æ–¹å¼(å³åŠ å…¥åˆ°é˜Ÿåˆ—)ï¼Œä½†æ˜¯ï¼Œè¿™ä¹ˆåšä¼šå°†æ•´ä¸ª <code>handler</code> éƒ½äº¤ç»™ä¸šåŠ¡çº¿ç¨‹æ± ã€‚ä¸è®ºè€—æ—¶ä¸è€—æ—¶ï¼Œéƒ½åŠ å…¥åˆ°é˜Ÿåˆ—é‡Œï¼Œä¸å¤Ÿçµæ´»ã€‚</p><p>3)å„æœ‰ä¼˜åŠ£ï¼Œä»çµæ´»æ€§è€ƒè™‘ï¼Œç¬¬ä¸€ç§è¾ƒå¥½ã€‚</p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/shenzehui/shenzehui.github.io/edit/main/docs/netty/chapter10.md" rel="noopener noreferrer" target="_blank" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡æ›´æ–°: </span><!----></div><!----></div></footer><nav class="page-nav"><a href="/netty/chapter09.html" class="nav-link prev" aria-label="ç¬¬ä¹ç«  TCP ç²˜åŒ…å’Œæ‹†åŒ…åŠè§£å†³æ–¹æ¡ˆ"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->ç¬¬ä¹ç«  TCP ç²˜åŒ…å’Œæ‹†åŒ…åŠè§£å†³æ–¹æ¡ˆ</div></a><a href="/netty/chapter11.html" class="nav-link next" aria-label="ç¬¬åä¸€ç«  ç”¨ Netty è‡ªå·±å®ç° Dubbo RPC"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">ç¬¬åä¸€ç«  ç”¨ Netty è‡ªå·±å®ç° Dubbo RPC<!----></div></a></nav><div class="giscus-wrapper input-top" id="comment" style="display:block;"><div class="loading-icon-wrapper" style="display:flex;align-items:center;justify-content:center;height:96px"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer"><a href="https://beian.miit.gov.cn/" target="_blank">è±«ICPå¤‡2021038026å·-1</a></div><div class="copyright">Copyright Â© 2022 Marico</div></footer></div><!--]--><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-7a87900e.js" defer></script>
  </body>
</html>
